popoto=function(){var a={version:"2.0.0-alpha.0",start:function(b){a.logger.info("Popoto "+a.version+" start on "+b);a.graph.mainLabel=b;if(void 0===a.rest.CYPHER_URL)a.logger.error("popoto.rest.CYPHER_URL is not set but is required.");else{a.checkHtmlComponents();a.taxonomy.isActive&&a.taxonomy.createTaxonomyPanel();if(a.graph.isActive)if(a.graph.createGraphArea(),a.graph.createForceLayout(),"string"===typeof b||b instanceof String){var c=a.provider.node.getSchema(b);void 0!==c?a.graph.addSchema(c):
a.graph.addRootNode(b)}else a.graph.addSchema(b);a.queryviewer.isActive&&a.queryviewer.createQueryArea();a.cypherviewer.isActive&&a.cypherviewer.createQueryArea();!0===a.graph.USE_VORONOI_LAYOUT&&a.graph.voronoi.extent([[-a.graph.getSVGWidth(),-a.graph.getSVGWidth()],[2*a.graph.getSVGWidth(),2*a.graph.getSVGHeight()]]);a.update()}},checkHtmlComponents:function(){var b=d3.select("#"+a.graph.containerId),c=d3.select("#"+a.taxonomy.containerId),d=d3.select("#"+a.queryviewer.containerId),e=d3.select("#"+
a.cypherviewer.containerId),f=d3.select("#"+a.result.containerId);b.empty()?(a.logger.debug("The page doesn't contain a container with ID = \""+a.graph.containerId+'" no graph area will be generated. This ID is defined in popoto.graph.containerId property.'),a.graph.isActive=!1):a.graph.isActive=!0;c.empty()?(a.logger.debug("The page doesn't contain a container with ID = \""+a.taxonomy.containerId+'" no taxonomy filter will be generated. This ID is defined in popoto.taxonomy.containerId property.'),
a.taxonomy.isActive=!1):a.taxonomy.isActive=!0;d.empty()?(a.logger.debug("The page doesn't contain a container with ID = \""+a.queryviewer.containerId+'" no query viewer will be generated. This ID is defined in popoto.queryviewer.containerId property.'),a.queryviewer.isActive=!1):a.queryviewer.isActive=!0;e.empty()?(a.logger.debug("The page doesn't contain a container with ID = \""+a.cypherviewer.containerId+'" no cypher query viewer will be generated. This ID is defined in popoto.cypherviewer.containerId property.'),
a.cypherviewer.isActive=!1):a.cypherviewer.isActive=!0;f.empty()?(a.logger.debug("The page doesn't contain a container with ID = \""+a.result.containerId+'" no result area will be generated. This ID is defined in popoto.result.containerId property.'),a.result.isActive=!1):a.result.isActive=!0},update:function(){a.updateGraph();var b=a.graph.getRootNode();b&&void 0!==b.label&&(a.queryviewer.isActive&&a.queryviewer.updateQuery(),a.cypherviewer.isActive&&a.cypherviewer.updateQuery(),(a.result.isActive||
0<a.result.resultListeners.length||0<a.result.resultCountListeners.length||0<a.result.graphResultListeners.length)&&a.result.updateResults())},updateGraph:function(){a.graph.isActive&&(a.graph.link.updateLinks(),a.graph.node.updateNodes(),a.graph.force.nodes(a.graph.nodes),a.graph.force.force("link").links(a.graph.links),a.graph.force.alpha(1).restart())},rest:{}};a.rest.CYPHER_URL="http://localhost:7474/db/data/transaction/commit";a.rest.post=function(b,c){var d=JSON.stringify(b);a.logger.info("REST POST:"+
d);var e={type:"POST",beforeSend:function(b){a.rest.AUTHORIZATION&&b.setRequestHeader("Authorization",a.rest.AUTHORIZATION)},contentType:"application/json"};void 0!==b&&(e.data=d);!0===a.rest.WITH_CREDENTIALS&&(e.xhrFields={withCredentials:!0});d=a.rest.CYPHER_URL;void 0!==c&&(d=c);return $.ajax(d,e)};a.rest.response={parse:function(b){a.logger.debug(JSON.stringify(b));var c=[];void 0!==b&&b.hasOwnProperty("results")&&0<b.results.length&&!(b.hasOwnProperty("errors")&&0<b.errors.length)&&(c=b.results.map(function(a){for(var b=
[],c=0;c<a.data.length;c++){for(var d={},h=0;h<a.columns.length;h++)d[a.columns[h]]=a.data[c].row[h];b.push(d)}return b}));a.logger.info(JSON.stringify(c));return c}};a.logger={};a.logger.LogLevels=Object.freeze({DEBUG:0,INFO:1,WARN:2,ERROR:3,NONE:4});a.logger.LEVEL=a.logger.LogLevels.NONE;a.logger.TRACE=!1;a.logger.log=function(b,c){if(console&&b>=a.logger.LEVEL)switch(a.logger.TRACE&&(c=c+"\n"+Error().stack),b){case a.logger.LogLevels.DEBUG:console.log(c);break;case a.logger.LogLevels.INFO:console.log(c);
break;case a.logger.LogLevels.WARN:console.warn(c);break;case a.logger.LogLevels.ERROR:console.error(c)}};a.logger.debug=function(b){a.logger.log(a.logger.LogLevels.DEBUG,b)};a.logger.info=function(b){a.logger.log(a.logger.LogLevels.INFO,b)};a.logger.warn=function(b){a.logger.log(a.logger.LogLevels.WARN,b)};a.logger.error=function(b){a.logger.log(a.logger.LogLevels.ERROR,b)};a.taxonomy={};a.taxonomy.containerId="popoto-taxonomy";a.taxonomy.createTaxonomyPanel=function(){var b=d3.select("#"+a.taxonomy.containerId).append("ul").attr("class",
"ppt-taxo-ul"),c=a.taxonomy.generateTaxonomiesData(),b=b.selectAll(".taxo").data(c).enter().append("li").attr("id",function(a){return a.id}).attr("class","ppt-taxo-li").attr("value",function(a){return a.label});b.append("span").attr("class",function(b){return"ppt-icon "+a.provider.taxonomy.getCSSClass(b.label,"span-icon")}).html("&nbsp;");b.append("span").attr("class","ppt-label").text(function(b){return a.provider.taxonomy.getTextValue(b.label)});b.append("span").attr("class","ppt-count");b.on("click",
a.taxonomy.onClick);a.taxonomy.addTaxonomyChildren(b);var d=[];c.forEach(function(b){d.push(b);b.children&&a.taxonomy.flattenChildren(b,d)});a.graph.DISABLE_COUNT||a.taxonomy.updateCount(d)};a.taxonomy.flattenChildren=function(b,c){b.children.forEach(function(b){c.push(b);b.children&&c.concat(a.taxonomy.flattenChildren(b,c))})};a.taxonomy.updateCount=function(b){var c=[];b.forEach(function(b){c.push({statement:a.query.generateTaxonomyCountQuery(b.label)})});(function(b){a.logger.info("Count taxonomies ==>");
a.rest.post({statements:c}).done(function(c){a.logger.info("<== Count taxonomies");c=a.rest.response.parse(c);for(var d=0;d<b.length;d++){var e=c[d][0].count;d3.select("#"+b[d].id).select(".ppt-count").text(" ("+e+")")}}).fail(function(b,c,d){a.logger.error(c+': error while accessing Neo4j server on URL:"'+a.rest.CYPHER_URL+'" defined in "popoto.rest.CYPHER_URL" property: '+d);d3.select("#popoto-taxonomy").selectAll(".ppt-count").text(" (0)")})})(b)};a.taxonomy.addTaxonomyChildren=function(b){b.each(function(b){var c=
d3.select(this),e=b.children;b.children&&(b=c.append("ul").attr("class","ppt-taxo-sub-ul").selectAll("li").data(e).enter().append("li").attr("id",function(a){return a.id}).attr("class","ppt-taxo-sub-li").attr("value",function(a){return a.label}),b.append("span").attr("class",function(b){return"ppt-icon "+a.provider.taxonomy.getCSSClass(b.label,"span-icon")}).html("&nbsp;"),b.append("span").attr("class","ppt-label").text(function(b){return a.provider.taxonomy.getTextValue(b.label)}),b.append("span").attr("class",
"ppt-count"),b.on("click",a.taxonomy.onClick),a.taxonomy.addTaxonomyChildren(b))})};a.taxonomy.onClick=function(){d3.event.stopPropagation();for(var b=this.attributes.value.value;0<a.graph.nodes.length;)a.graph.nodes.pop();for(;0<a.graph.links.length;)a.graph.links.pop();a.graph.node.internalLabels={};a.update();a.graph.mainLabel=b;void 0!==a.provider.node.getSchema(b)?a.graph.addSchema(a.provider.node.getSchema(b)):a.graph.addRootNode(b);a.graph.hasGraphChanged=!0;a.result.hasChanged=!0;a.graph.ignoreCount=
!1;a.update();a.tools.center()};a.taxonomy.generateTaxonomiesData=function(){var b=0,c=[],d;for(d in a.provider.node.Provider)a.provider.node.Provider.hasOwnProperty(d)&&a.provider.node.getProperty(d,"isSearchable")&&!a.provider.node.Provider[d].parent&&c.push({label:d,id:"popoto-lbl-"+b++});c.forEach(function(c){a.provider.node.getProvider(c.label).hasOwnProperty("children")&&(b=a.taxonomy.addChildrenData(c,b))});return c};a.taxonomy.addChildrenData=function(b,c){b.children=[];a.provider.node.getProvider(b.label).children.forEach(function(d){var e=
a.provider.node.getProvider(d),f={label:d,id:"popoto-lbl-"+c++};e.hasOwnProperty("children")&&(c=a.taxonomy.addChildrenData(f,c));a.provider.node.getProperty(d,"isSearchable")&&b.children.push(f)});return c};a.tootip={};a.tools={};a.tools.CENTER_GRAPH=!0;a.tools.RESET_GRAPH=!0;a.tools.SAVE_GRAPH=!1;a.tools.TOGGLE_TAXONOMY=!0;a.tools.TOGGLE_FULL_SCREEN=!0;a.tools.TOGGLE_VIEW_RELATION=!0;a.tools.reset=function(){for(;0<a.graph.nodes.length;)a.graph.nodes.pop();for(;0<a.graph.links.length;)a.graph.links.pop();
a.graph.node.internalLabels={};"string"===typeof a.graph.mainLabel||a.graph.mainLabel instanceof String?void 0!==a.provider.node.getSchema(a.graph.mainLabel)?a.graph.addSchema(a.provider.node.getSchema(a.graph.mainLabel)):a.graph.addRootNode(a.graph.mainLabel):a.graph.addSchema(a.graph.mainLabel);a.graph.hasGraphChanged=!0;a.result.hasChanged=!0;a.update();a.tools.center()};a.tools.center=function(){a.graph.svgTag.transition().call(a.graph.zoom.transform,d3.zoomIdentity)};a.tools.toggleTaxonomy=function(){var b=
d3.select("#"+a.taxonomy.containerId);b.filter(".disabled").empty()?b.classed("disabled",!0):b.classed("disabled",!1);a.graph.centerRootNode()};a.tools.toggleViewRelation=function(){a.graph.DISABLE_RELATION=!a.graph.DISABLE_RELATION;d3.selectAll(".ppt-g-node-background").classed("hide",a.graph.DISABLE_RELATION);a.graph.tick()};a.tools.toggleFullScreen=function(){var b=document.getElementById(a.graph.containerId);document.fullscreenElement||document.mozFullScreenElement||document.webkitFullscreenElement||
document.msFullscreenElement?document.exitFullscreen?document.exitFullscreen():document.msExitFullscreen?document.msExitFullscreen():document.mozCancelFullScreen?document.mozCancelFullScreen():document.webkitExitFullscreen&&document.webkitExitFullscreen():b.requestFullscreen?b.requestFullscreen():b.msRequestFullscreen?b.msRequestFullscreen():b.mozRequestFullScreen?b.mozRequestFullScreen():b.webkitRequestFullscreen&&b.webkitRequestFullscreen(Element.ALLOW_KEYBOARD_INPUT)};a.graph={};a.graph.idGen=
0;a.graph.nodes=[];a.graph.links=[];a.graph.containerId="popoto-graph";a.graph.hasGraphChanged=!0;a.graph.zoom=d3.zoom().scaleExtent([.1,10]);a.graph.WHEEL_ZOOM_ENABLED=!0;a.graph.TOOL_TAXONOMY="Show/hide taxonomy panel";a.graph.TOOL_RELATION="Show/hide relation";a.graph.TOOL_CENTER="Center view";a.graph.TOOL_FULL_SCREEN="Full screen";a.graph.TOOL_RESET="Reset graph";a.graph.TOOL_SAVE="Save graph";a.graph.USE_DONUT_FORCE=!1;a.graph.USE_VORONOI_LAYOUT=!1;a.graph.Events=Object.freeze({NODE_ROOT_ADD:"root.node.add",
NODE_EXPAND_RELATIONSHIP:"node.expandRelationship",GRAPH_SAVE:"graph.save",GRAPH_RESET:"graph.reset",GRAPH_NODE_VALUE_EXPAND:"graph.node.value_expand",GRAPH_NODE_VALUE_COLLAPSE:"graph.node.value_collapse",GRAPH_NODE_ADD_VALUE:"graph.node.add_value",GRAPH_NODE_DATA_LOADED:"graph.node.data_loaded"});a.graph.generateId=function(){return a.graph.idGen++};a.graph.listeners={};a.graph.on=function(b,c){a.graph.listeners.hasOwnProperty(b)||(a.graph.listeners[b]=[]);a.graph.listeners[b].push(c)};a.graph.notifyListeners=
function(b,c){a.graph.listeners.hasOwnProperty(b)&&a.graph.listeners[b].forEach(function(a){a.apply(b,c)})};a.graph.onSave=function(b){a.graph.on(a.graph.Events.GRAPH_SAVE,b)};a.graph.onReset=function(b){a.graph.on(a.graph.Events.GRAPH_RESET,b)};a.graph.setDefaultGraph=function(b){a.graph.mainLabel=b};a.graph.createGraphArea=function(){var b=d3.select("#"+a.graph.containerId),c=b.append("div").attr("class","ppt-toolbar");if(a.tools.TOGGLE_VIEW_RELATION)c.append("span").attr("id","popoto-toggle-relation").attr("class",
"ppt-icon ppt-menu relation").attr("title",a.graph.TOOL_RELATION).on("click",function(){a.tools.toggleViewRelation()});if(a.tools.RESET_GRAPH)c.append("span").attr("id","popoto-reset-menu").attr("class","ppt-icon ppt-menu reset").attr("title",a.graph.TOOL_RESET).on("click",function(){a.graph.notifyListeners(a.graph.Events.GRAPH_RESET,[]);a.tools.reset()});if(a.taxonomy.isActive&&a.tools.TOGGLE_TAXONOMY)c.append("span").attr("id","popoto-taxonomy-menu").attr("class","ppt-icon ppt-menu taxonomy").attr("title",
a.graph.TOOL_TAXONOMY).on("click",a.tools.toggleTaxonomy);if(a.tools.CENTER_GRAPH)c.append("span").attr("id","popoto-center-menu").attr("class","ppt-icon ppt-menu center").attr("title",a.graph.TOOL_CENTER).on("click",a.tools.center);if(a.tools.TOGGLE_FULL_SCREEN)c.append("span").attr("id","popoto-fullscreen-menu").attr("class","ppt-icon ppt-menu fullscreen").attr("title",a.graph.TOOL_FULL_SCREEN).on("click",a.tools.toggleFullScreen);if(a.tools.SAVE_GRAPH)c.append("span").attr("id","popoto-save-menu").attr("class",
"ppt-icon ppt-menu save").attr("title",a.graph.TOOL_SAVE).on("click",function(){a.graph.notifyListeners(a.graph.Events.GRAPH_SAVE,[a.graph.getSchema()])});a.graph.svgTag=b.append("svg").attr("class","ppt-svg-graph").call(a.graph.zoom.on("zoom",a.graph.rescale));a.graph.svgTag.on("dblclick.zoom",null);if(!a.graph.WHEEL_ZOOM_ENABLED)a.graph.svgTag.on("wheel.zoom",null).on("mousewheel.zoom",null);a.graph.svgdefs=a.graph.svgTag.append("defs");a.graph.svgdefs.append("marker").attr("id","cross").attr("refX",
10).attr("refY",10).attr("markerWidth",20).attr("markerHeight",20).attr("markerUnits","strokeWidth").attr("orient","auto").append("path").attr("class","ppt-marker-cross").attr("d","M5,5 L15,15 M15,5 L5,15");a.graph.svgdefs.append("marker").attr("id","arrow").attr("refX",9).attr("refY",3).attr("markerWidth",10).attr("markerHeight",10).attr("markerUnits","strokeWidth").attr("orient","auto").append("path").attr("class","ppt-marker-arrow").attr("d","M0,0 L0,6 L9,3 z");a.graph.svgdefs.append("marker").attr("id",
"reverse-arrow").attr("refX",0).attr("refY",3).attr("markerWidth",10).attr("markerHeight",10).attr("markerUnits","strokeWidth").attr("orient","auto").append("path").attr("class","ppt-marker-reverse-arrow").attr("d","M0,3 L9,6 L9,0 z");a.graph.svgdefs.append("filter").attr("id","grayscale").append("feColorMatrix").attr("type","saturate").attr("values","0");b=a.graph.svgdefs.append("filter").attr("id","gooey");b.append("feGaussianBlur").attr("in","SourceGraphic").attr("stdDeviation","10").attr("color-interpolation-filters",
"sRGB").attr("result","blur");b.append("feColorMatrix").attr("class","blurValues").attr("in","blur").attr("mode","matrix").attr("values","1 0 0 0 0  0 1 0 0 0  0 0 1 0 0  0 0 0 35 -6").attr("result","gooey");b.append("feBlend").attr("in","SourceGraphic").attr("in2","gooey").attr("operator","atop");a.graph.svgdefs.append("g").attr("id","voronoi-clip-path");a.graph.svg=a.graph.svgTag.append("svg:g");a.graph.svg.append("g").attr("id",a.graph.link.gID);a.graph.svg.append("g").attr("id",a.graph.node.gID);
window.addEventListener("resize",a.graph.centerRootNode)};a.graph.centerRootNode=function(){a.graph.getRootNode().fx=a.graph.getSVGWidth()/2;a.graph.getRootNode().fy=a.graph.getSVGHeight()/2;a.update()};a.graph.getSVGWidth=function(){return"undefined"==typeof a.graph.svg||a.graph.svg.empty()?(a.logger.debug("popoto.graph.svg is undefined or empty."),0):document.getElementById(a.graph.containerId).clientWidth};a.graph.getSVGHeight=function(){return"undefined"==typeof a.graph.svg||a.graph.svg.empty()?
(a.logger.debug("popoto.graph.svg is undefined or empty."),0):document.getElementById(a.graph.containerId).clientHeight};a.graph.rescale=function(){a.graph.svg.attr("transform",d3.event.transform)};a.graph.CHARGE=-500;a.graph.createForceLayout=function(){a.graph.force=d3.forceSimulation().force("charge",d3.forceManyBody().strength(function(b){return b.charge?b.charge:a.graph.CHARGE})).force("link",d3.forceLink().id(function(a){return a.id}).distance(a.provider.link.getDistance));a.graph.force.nodes(a.graph.nodes);
a.graph.force.force("link").links(a.graph.links);a.graph.force.on("tick",a.graph.tick)};a.graph.addRootNode=function(b){0<a.graph.nodes.length&&a.logger.warn("popoto.graph.addRootNode is called but the graph is not empty.");if(void 0!==a.provider.node.getSchema(b))a.graph.addSchema(a.provider.node.getSchema(b));else{var c={id:a.graph.generateId(),type:a.graph.node.NodeTypes.ROOT,x:a.graph.getSVGWidth()/2,y:a.graph.getSVGHeight()/2,fx:a.graph.getSVGWidth()/2,fy:a.graph.getSVGHeight()/2,tx:a.graph.getSVGWidth()/
2,ty:a.graph.getSVGHeight()/2,label:b,fixed:!0,internalLabel:a.graph.node.generateInternalLabel(b),relationships:[],isAutoLoadValue:!0===a.provider.node.getIsAutoLoadValue(b)};a.graph.nodes.push(c);a.graph.notifyListeners(a.graph.Events.NODE_ROOT_ADD,[c]);a.graph.node.loadRelationshipData(c,function(d){c.relationships=d;a.provider.node.getIsAutoExpandRelations(b)?(a.graph.ignoreCount=!0,a.graph.node.expandRelationships(c,function(){a.graph.ignoreCount=!1;a.graph.hasGraphChanged=!0;a.updateGraph()})):
(a.graph.hasGraphChanged=!0,a.updateGraph())},Math.PI/2)}};a.graph.addSchema=function(b){0<a.graph.nodes.length&&a.logger.warn("popoto.graph.addSchema is called but the graph is not empty.");var c={id:a.graph.generateId(),type:a.graph.node.NodeTypes.ROOT,x:a.graph.getSVGWidth()/2,y:a.graph.getSVGHeight()/2,fx:a.graph.getSVGWidth()/2,fy:a.graph.getSVGHeight()/2,tx:a.graph.getSVGWidth()/2,ty:a.graph.getSVGHeight()/2,label:b.label,fixed:!0,internalLabel:a.graph.node.generateInternalLabel(b.label),relationships:[],
isAutoLoadValue:!0===a.provider.node.getIsAutoLoadValue(b.label)};a.graph.nodes.push(c);a.graph.notifyListeners(a.graph.Events.NODE_ROOT_ADD,[c]);if(b.hasOwnProperty("rel")&&0<b.rel.length){var d=Math.PI/2;c.relationships=a.graph.node.pie.startAngle(d-Math.PI).endAngle(d+Math.PI)(b.rel).map(function(a){return{id:a.data.label+a.data.target.label,label:a.data.label,target:a.data.target.label,count:0,startAngle:a.startAngle,endAngle:a.endAngle,directionAngle:(a.startAngle+a.endAngle)/2}})}};a.graph.addSchemaRelation=
function(b,c,d,e){d=a.graph.addSchemaNode(b.target,c,d,e,b.label);b={id:"l"+a.graph.generateId(),source:c,target:d,type:a.graph.link.LinkTypes.RELATION,label:b.label,schema:b};a.graph.links.push(b)};a.graph.addSchemaNode=function(b,c,d,e,f){var g=a.provider.node.getIsGroup(b),h=b.hasOwnProperty("collapsed")&&!0===b.collapsed,l=a.graph.computeParentAngle(c);e=l?360/(e+1)*d:360/e*d;d=c.x+200*Math.cos(Math.PI/180*e-l);var l=c.y+200*Math.sin(Math.PI/180*e-l),k={id:a.graph.generateId(),parent:c,parentRel:f,
type:g?a.graph.node.NodeTypes.GROUP:a.graph.node.NodeTypes.CHOOSE,label:b.label,fixed:!1,internalLabel:a.graph.node.generateInternalLabel(b.label),x:d,y:l,schema:b,isAutoLoadValue:!0===a.provider.node.getIsAutoLoadValue(b.label),relationships:[]};if(b.hasOwnProperty("rel")&&0<b.rel.length){c={};f=[];for(g=0;g<b.rel.length;g++)l=b.rel[g],d=l.label+l.target.label,c.hasOwnProperty(d)||(c[d]=l,f.push(l));k.relationships=a.graph.node.pie(f).map(function(a){return{id:a.data.label+a.data.target.label,count:a.data.count||
0,label:a.data.label,target:a.data.target.label,startAngle:a.startAngle,endAngle:a.endAngle,directionAngle:(a.startAngle+a.endAngle)/2}})}b.hasOwnProperty("value")&&(c=[].concat(b.value),k.value=[],c.forEach(function(b){k.value.push({id:a.graph.generateId(),parent:k,attributes:b,type:a.graph.node.NodeTypes.VALUE,label:k.label})}));a.graph.nodes.push(k);if(!h&&b.hasOwnProperty("rel"))for(h=0;h<b.rel.length;h++)a.graph.addSchemaRelation(b.rel[h],k,h+1,b.rel.length);return k};a.graph.getRootNode=function(){if(void 0!==
a.graph.force)return a.graph.nodes[0]};a.graph.getSchema=function(){function b(b){var c=a.graph.links;0<c.length&&c.forEach(function(a){if(a.source===b)return!1});return!0}var c={},d=a.graph.getRootNode();c[d.id]={label:d.label};d.hasOwnProperty("value")&&(c[d.id].value=[],d.value.forEach(function(a){c[d.id].value.push(a.attributes)}));var e=a.graph.links;0<e.length&&e.forEach(function(d){if(d.type===a.graph.link.LinkTypes.RELATION){var e=d.source,f=d.target;c.hasOwnProperty(e.id)||(c[e.id]={label:e.label},
e.hasOwnProperty("value")&&(c[e.id].value=[],e.value.forEach(function(a){c[e.id].value.push(a.attributes)})));c.hasOwnProperty(f.id)||(c[f.id]={label:f.label},f.hasOwnProperty("value")&&(c[f.id].value=[],f.value.forEach(function(a){c[f.id].value.push(a.attributes)})),b(f)&&f.hasOwnProperty("relationships")&&0<f.relationships.length&&(c[f.id].rel=[],c[f.id].collapsed=!0,f.relationships.forEach(function(a){c[f.id].rel.push({label:a.label,target:{label:a.target}})})));c[e.id].hasOwnProperty("rel")||
(c[e.id].rel=[]);c[e.id].rel.push({label:d.label,target:c[f.id]})}});return c[d.id]};a.graph.tick=function(){var b=a.graph.svg.selectAll("#"+a.graph.link.gID+" > g");b.selectAll(".ppt-link").attr("d",function(b){var c=b.source;b=b.target;var e=a.graph.computeParentAngle(b),f=a.provider.node.getSize(c),g=a.provider.node.getSize(b);!a.graph.DISABLE_RELATION&&c.hasOwnProperty("relationships")&&0<c.relationships.length&&(f=a.graph.node.getDonutOuterRadius(c));!a.graph.DISABLE_RELATION&&b.hasOwnProperty("relationships")&&
0<b.relationships.length&&(g=a.graph.node.getDonutOuterRadius(b));var h=b.x+g*Math.cos(e),g=b.y-g*Math.sin(e),l=c.x-f*Math.cos(e),e=c.y+f*Math.sin(e),f=(h+l)/2,k=(g+e)/2;return c.x<=b.x||!0===a.graph.ignoreMirroLinkLabels?"M"+l+" "+e+"L"+f+" "+k+"L"+h+" "+g:"M"+h+" "+g+"L"+f+" "+k+"L"+l+" "+e}).attr("marker-end",function(b){return a.graph.link.SHOW_MARKER&&b.source.x<=b.target.x?"url(#arrow)":null}).attr("marker-start",function(b){return a.graph.link.SHOW_MARKER&&b.source.x>b.target.x?"url(#reverse-arrow)":
null});b.selectAll(".ppt-textPath").attr("xlink:href",function(a){return"#ppt-path_"+a.id});a.graph.svg.selectAll("#"+a.graph.node.gID+" > g").attr("transform",function(a){return"translate("+a.x+","+a.y+")"});!0===a.graph.USE_VORONOI_LAYOUT&&(b=d3.select("#voronoi-clip-path").selectAll(".voroclip").data(a.graph.recenterVoronoi(a.graph.nodes),function(a){return a.point.id}),b.enter().append("clipPath").attr("id",function(a){return"voroclip-"+a.point.id}).attr("class","voroclip"),b.exit().remove(),
b.selectAll("path").remove(),b.append("path").attr("id",function(a){return"pvoroclip-"+a.point.id}).attr("d",function(a){return"M"+a.join(",")+"Z"}))};a.graph.link={};a.graph.link.TEXT_DY=-4;a.graph.link.SHOW_MARKER=!1;a.graph.link.gID="popoto-glinks";a.graph.link.LinkTypes=Object.freeze({RELATION:0,VALUE:1,SEGMENT:2});a.graph.link.updateLinks=function(){var b=a.graph.link.updateData();a.graph.link.removeElements(b.exit());a.graph.link.addNewElements(b.enter());a.graph.link.updateElements()};a.graph.link.updateData=
function(){return a.graph.svg.select("#"+a.graph.link.gID).selectAll(".ppt-glink").data(a.graph.links,function(a){return a.id})};a.graph.link.removeElements=function(a){a.remove()};a.graph.link.addNewElements=function(b){b=b.append("g").attr("class","ppt-glink").on("click",a.graph.link.clickLink).on("mouseover",a.graph.link.mouseOverLink).on("mouseout",a.graph.link.mouseOutLink);b.append("path").attr("class","ppt-link");b.append("text").attr("text-anchor","middle").attr("dy",a.graph.link.TEXT_DY).append("textPath").attr("class",
"ppt-textPath").attr("startOffset","50%")};a.graph.link.updateElements=function(){var b=a.graph.svg.select("#"+a.graph.link.gID).selectAll(".ppt-glink");b.attr("id",function(a){return"ppt-glink_"+a.id});b.selectAll(".ppt-link").attr("id",function(a){return"ppt-path_"+a.id}).attr("stroke",function(b){return a.provider.link.getColor(b,"path","stroke")}).attr("class",function(b){return"ppt-link "+a.provider.link.getCSSClass(b,"path")});b.selectAll("text").attr("id",function(a){return"ppt-text_"+a.id}).attr("class",
function(b){return a.provider.link.getCSSClass(b,"text")}).attr("fill",function(b){return a.provider.link.getColor(b,"text","fill")}).selectAll(".ppt-textPath").attr("id",function(a){return"ppt-textpath_"+a.id}).attr("class",function(b){return"ppt-textpath "+a.provider.link.getCSSClass(b,"text-path")}).attr("xlink:href",function(a){return"#ppt-path_"+a.id}).text(function(b){return a.provider.link.getTextValue(b)})};a.graph.link.mouseOverLink=function(){d3.select(this).select("path").attr("class",
function(b){return"ppt-link "+a.provider.link.getCSSClass(b,"path--hover")});d3.select(this).select("text").attr("class",function(b){return a.provider.link.getCSSClass(b,"text--hover")});var b=d3.select(this).data()[0];a.queryviewer.isActive&&(a.queryviewer.queryConstraintSpanElements.filter(function(a){return a.ref===b}).classed("hover",!0),a.queryviewer.querySpanElements.filter(function(a){return a.ref===b}).classed("hover",!0));a.cypherviewer.isActive&&a.cypherviewer.querySpanElements.filter(function(a){return a.link===
b}).classed("hover",!0)};a.graph.link.mouseOutLink=function(){d3.select(this).select("path").attr("class",function(b){return"ppt-link "+a.provider.link.getCSSClass(b,"path")});d3.select(this).select("text").attr("class",function(b){return a.provider.link.getCSSClass(b,"text")});var b=d3.select(this).data()[0];a.queryviewer.isActive&&(a.queryviewer.queryConstraintSpanElements.filter(function(a){return a.ref===b}).classed("hover",!1),a.queryviewer.querySpanElements.filter(function(a){return a.ref===
b}).classed("hover",!1));a.cypherviewer.isActive&&a.cypherviewer.querySpanElements.filter(function(a){return a.link===b}).classed("hover",!1)};a.graph.link.clickLink=function(){var b=d3.select(this).data()[0];b.type!==a.graph.link.LinkTypes.VALUE&&(a.graph.node.collapseAllNode(),b=a.graph.node.removeNode(b.target),a.graph.hasGraphChanged=!0,a.result.hasChanged=b,a.update())};a.graph.node={};a.graph.node.gID="popoto-gnodes";a.graph.node.DONUTS_MARGIN=0;a.graph.node.DONUT_WIDTH=20;a.graph.DISABLE_RELATION=
!1;a.graph.node.TEXT_Y=8;a.graph.node.NODE_MAX_CHARS=11;a.graph.node.NODE_TITLE_MAX_CHARS=100;a.graph.node.PAGE_SIZE=10;a.graph.DISABLE_COUNT=!1;a.graph.node.CountBox={x:16,y:33,w:52,h:19};a.graph.node.chooseWaiting=!1;a.graph.node.getDonutInnerRadius=function(b){return a.provider.node.getSize(b)+a.graph.node.DONUTS_MARGIN};a.graph.node.getDonutOuterRadius=function(b){return a.provider.node.getSize(b)+a.graph.node.DONUTS_MARGIN+a.graph.node.DONUT_WIDTH};a.graph.node.pie=d3.pie().sort(null).value(function(a){return 1});
a.graph.node.NodeTypes=Object.freeze({ROOT:0,CHOOSE:1,VALUE:2,GROUP:3});a.graph.node.internalLabels={};a.graph.node.generateInternalLabel=function(b){b=b?b.toLowerCase().replace(/ /g,""):"n";if(b in a.graph.node.internalLabels)a.graph.node.internalLabels[b]+=1;else return a.graph.node.internalLabels[b]=0,b;return b+a.graph.node.internalLabels[b]};a.graph.node.updateNodes=function(){var b=a.graph.node.updateData();a.graph.node.removeElements(b.exit());a.graph.node.addNewElements(b.enter());a.graph.node.updateElements()};
a.graph.node.updateData=function(){var b=a.graph.svg.select("#"+a.graph.node.gID).selectAll(".ppt-gnode").data(a.graph.nodes,function(a){return a.id});a.graph.hasGraphChanged&&(a.graph.node.updateAutoLoadValues(),a.graph.DISABLE_COUNT||a.graph.ignoreCount||a.graph.node.updateCount());a.graph.hasGraphChanged=!1;return b};a.graph.node.updateCount=function(){void 0!==a.graph.node.updateCountXhr&&a.graph.node.updateCountXhr.abort();var b=[],c=a.graph.nodes.filter(function(b){return b.type!==a.graph.node.NodeTypes.VALUE&&
b.type!==a.graph.node.NodeTypes.GROUP&&(!b.hasOwnProperty("isNegative")||!b.isNegative)});c.forEach(function(c){c=a.query.generateNodeCountQuery(c);b.push({statement:c.statement,parameters:c.parameters})});a.logger.info("Count nodes ==>");a.graph.node.updateCountXhr=a.rest.post({statements:b}).done(function(b){a.logger.info("<== Count nodes");b=a.rest.response.parse(b);for(var d=0;d<c.length;d++)c[d].count=b[d][0].count;0<a.result.resultCountListeners.length&&a.result.updateResultsCount();a.graph.node.updateElements();
a.graph.link.updateElements()}).fail(function(b,e,f){"abort"!==e?(a.logger.error(e+': error while accessing Neo4j server on URL:"'+a.rest.CYPHER_URL+'" defined in "popoto.rest.CYPHER_URL" property: '+f),c.forEach(function(a){a.count=0}),a.graph.node.updateElements(),a.graph.link.updateElements()):a.logger.info("<=X= Count nodes - Aborted!")})};a.graph.node.updateAutoLoadValues=function(){for(var b=[],c=a.graph.node.getAutoLoadValueNodes(),d=0;d<c.length;d++){var e=a.query.generateNodeValueQuery(c[d]);
b.push({statement:e.statement,parameters:e.parameters})}0<b.length&&(a.logger.info("AutoLoadValue ==>"),a.rest.post({statements:b}).done(function(b){a.logger.info("<== AutoLoadValue");b=a.rest.response.parse(b);for(var d=0;d<c.length;d++){var e=c[d],f=a.provider.node.getConstraintAttribute(e.label);e.data=b[d].filter(function(a){var b=!0;e.hasOwnProperty("value")&&0<e.value.length&&e.value.forEach(function(c){c.attributes[f]===a[f]&&(b=!1)});return b});e.page=1}a.graph.notifyListeners(a.graph.Events.GRAPH_NODE_DATA_LOADED,
[c])}).fail(function(b,c,d){a.logger.error(c+': error while accessing Neo4j server on URL:"'+a.rest.CYPHER_URL+'" defined in "popoto.rest.CYPHER_URL" property: '+d)}))};a.graph.node.removeElements=function(a){a.filter(function(a){return!a.parent}).remove();a.filter(function(a){return a.parent}).transition().duration(300).attr("transform",function(a){return"translate("+a.parent.x+","+a.parent.y+")"}).remove()};a.graph.node.addNewElements=function(b){b=b.append("g").attr("class","ppt-gnode");b.on("click",
a.graph.node.nodeClick).on("mouseover",a.graph.node.mouseOverNode).on("mouseout",a.graph.node.mouseOutNode);b.filter(function(b){return b.type!==a.graph.node.NodeTypes.VALUE}).on("contextmenu",a.graph.node.clearSelection);b.filter(function(b){return b.type===a.graph.node.NodeTypes.VALUE}).on("contextmenu",function(){d3.event.preventDefault()});b.append("defs").append("clipPath").attr("id",function(a){return"node-view"+a.id}).append("circle").attr("cx",0).attr("cy",0);a.graph.node.addBackgroundElements(b);
a.graph.node.addMiddlegroundElements(b);a.graph.node.addForegroundElements(b)};a.graph.node.addBackgroundElements=function(b){b=b.append("g").attr("class","ppt-g-node-background").classed("hide",a.graph.DISABLE_RELATION);b.append("g").attr("class","ppt-donut-labels");b.append("g").attr("class","ppt-donut-segments")};a.graph.node.addMiddlegroundElements=function(a){a.append("g").attr("class","ppt-g-node-middleground")};a.graph.node.addForegroundElements=function(b){b=b.append("g").attr("class","ppt-g-node-foreground");
var c=b.filter(function(b){return b.type===a.graph.node.NodeTypes.ROOT||b.type===a.graph.node.NodeTypes.CHOOSE}).append("g").attr("class","ppt-node-foreground-g-arrows"),d=c.append("g");d.append("circle").attr("class","ppt-larrow").attr("cx","-43").attr("cy","-23").attr("r","17");d.append("path").attr("class","ppt-arrow").attr("d","m -44.905361,-23 6.742,-6.742 c 0.81,-0.809 0.81,-2.135 0,-2.944 l -0.737,-0.737 c -0.81,-0.811 -2.135,-0.811 -2.945,0 l -8.835,8.835 c -0.435,0.434 -0.628,1.017 -0.597,1.589 -0.031,0.571 0.162,1.154 0.597,1.588 l 8.835,8.834 c 0.81,0.811 2.135,0.811 2.945,0 l 0.737,-0.737 c 0.81,-0.808 0.81,-2.134 0,-2.943 l -6.742,-6.743 z");
d.on("click",function(b){d3.event.stopPropagation();1<b.page&&(b.page--,a.graph.node.collapseNode(b),a.graph.node.expandNode(b))});c=c.append("g");c.append("circle").attr("class","ppt-rarrow").attr("cx","43").attr("cy","-23").attr("r","17");c.append("path").attr("class","ppt-arrow").attr("d","m 51.027875,-24.5875 -8.835,-8.835 c -0.811,-0.811 -2.137,-0.811 -2.945,0 l -0.738,0.737 c -0.81,0.81 -0.81,2.136 0,2.944 l 6.742,6.742 -6.742,6.742 c -0.81,0.81 -0.81,2.136 0,2.943 l 0.737,0.737 c 0.81,0.811 2.136,0.811 2.945,0 l 8.835,-8.836 c 0.435,-0.434 0.628,-1.017 0.597,-1.588 0.032,-0.569 -0.161,-1.152 -0.596,-1.586 z");
c.on("click",function(b){d3.event.stopPropagation();b.page*a.graph.node.PAGE_SIZE<b.count&&(b.page++,a.graph.node.collapseNode(b),a.graph.node.expandNode(b))});a.graph.DISABLE_COUNT||(c=b.filter(function(b){return b.type!==a.graph.node.NodeTypes.GROUP}),c.append("rect").attr("x",a.graph.node.CountBox.x).attr("y",a.graph.node.CountBox.y).attr("width",a.graph.node.CountBox.w).attr("height",a.graph.node.CountBox.h).attr("class","ppt-count-box"),c.append("text").attr("x",42).attr("y",48).attr("text-anchor",
"middle").attr("class","ppt-count-text"));b.filter(function(b){return b.type===a.graph.node.NodeTypes.CHOOSE}).append("g").attr("class","ppt-g-node-ban").append("path").attr("d","M89.1 19.2C88 17.7 86.6 16.2 85.2 14.8 83.8 13.4 82.3 12 80.8 10.9 72 3.9 61.3 0 50 0 36.7 0 24.2 5.4 14.8 14.8 5.4 24.2 0 36.7 0 50c0 11.4 3.9 22.1 10.9 30.8 1.2 1.5 2.5 3 3.9 4.4 1.4 1.4 2.9 2.7 4.4 3.9C27.9 96.1 38.6 100 50 100 63.3 100 75.8 94.6 85.2 85.2 94.6 75.8 100 63.3 100 50 100 38.7 96.1 28 89.1 19.2ZM11.9 50c0-10.2 4-19.7 11.1-27C30.3 15.9 39.8 11.9 50 11.9c8.2 0 16 2.6 22.4 7.3L19.3 72.4C14.5 66 11.9 58.2 11.9 50Zm65 27c-7.2 7.1-16.8 11.1-27 11.1-8.2 0-16-2.6-22.4-7.4L80.8 27.6C85.5 34 88.1 41.8 88.1 50c0 10.2-4 19.7-11.1 27z")};
a.graph.node.updateElements=function(){var b=a.graph.svg.select("#"+a.graph.node.gID).selectAll(".ppt-gnode");b.attr("id",function(a){return"popoto-gnode_"+a.id});a.graph.USE_VORONOI_LAYOUT&&b.attr("clip-path",function(a){return"url(#voroclip-"+a.id+")"});b.select("defs").select("clipPath").attr("id",function(a){return"node-view"+a.id}).selectAll("circle").attr("r",function(b){return a.provider.node.getSize(b)});b.filter(function(b){return b.type!==a.graph.node.NodeTypes.ROOT}).call(d3.drag().on("start",
function(b){d3.event.active||a.graph.force.alphaTarget(.3).restart();b.fx=b.x;b.fy=b.y}).on("drag",function(a){a.fx=d3.event.x;a.fy=d3.event.y}).on("end",function(b){d3.event.active||a.graph.force.alphaTarget(0);!1===b.fixed&&(b.fx=null,b.fy=null)}));a.graph.node.updateBackgroundElements();a.graph.node.updateMiddlegroundElements();a.graph.node.updateForegroundElements()};a.graph.node.updateBackgroundElements=function(){var b=a.graph.svg.select("#"+a.graph.node.gID).selectAll(".ppt-gnode").selectAll(".ppt-g-node-background");
b.select(".ppt-donut-labels").selectAll("*").remove();b.select(".ppt-donut-segments").selectAll("*").remove();var c=b.select(".ppt-donut-segments").selectAll(".ppt-segment-container").data(function(a){var b=[];a.hasOwnProperty("relationships")&&(b=a.relationships);return b},function(a){return a.id}).enter().append("g").attr("class",".ppt-segment-container").on("click",a.graph.node.segmentClick).on("mouseover",function(a){d3.select(this).select(".ppt-text-arc").classed("hover",!0)}).on("mouseout",
function(a){d3.select(this).select(".ppt-text-arc").classed("hover",!1)});c.append("title").attr("class","ppt-svg-title").text(function(a){return a.label+" "+a.target});b.select(".ppt-donut-labels").selectAll(".ppt-segment-container").data(function(a){var b=[];a.hasOwnProperty("relationships")&&(b=a.relationships);return b},function(a){return a.id}).enter().append("g").attr("class",".ppt-segment-container").on("click",a.graph.node.segmentClick).on("mouseover",function(a){d3.select(this).select(".ppt-text-arc").classed("hover",
!0)}).on("mouseout",function(a){d3.select(this).select(".ppt-text-arc").classed("hover",!1)}).append("path").attr("class","ppt-hidden-arc").attr("id",function(a,b){return"arc_"+d3.select(this.parentNode.parentNode).datum().id+"_"+b}).attr("d",function(b){var c=d3.select(this.parentNode.parentNode).datum(),d=/(^.+?)M/;b={startAngle:b.directionAngle-(Math.PI-.1),endAngle:b.directionAngle+(Math.PI-.1)};c=d3.arc().innerRadius(a.graph.node.getDonutInnerRadius(c)).outerRadius(a.graph.node.getDonutOuterRadius(c))(b);
d=(b=/(^.+?)L/.exec(c))&&1<b.length?b[1]:d.exec(c)[1];return d=d.replace(/,/g," ")}).style("fill","none").style("stroke","none");c.append("text").attr("text-anchor","middle").attr("class",function(a){a=d3.select(this.parentNode.parentNode).datum();return a.hasOwnProperty("count")&&0===a.count?"ppt-text-arc disabled":"ppt-text-arc"}).attr("fill",function(b){var c=d3.select(this.parentNode.parentNode).datum();return a.provider.link.getColor({label:b.label,type:a.graph.link.LinkTypes.SEGMENT,source:c,
target:{label:b.target}},"segment","fill")}).attr("dy",a.graph.link.TEXT_DY).append("textPath").attr("startOffset","50%").attr("xlink:href",function(a,b){return"#arc_"+d3.select(this.parentNode.parentNode.parentNode).datum().id+"_"+b}).text(function(b){var c=d3.select(this.parentNode.parentNode.parentNode).datum();return a.provider.link.getTextValue({source:c,target:{label:b.target},label:b.label,type:a.graph.link.LinkTypes.SEGMENT})});c.append("path").attr("class",function(a){a=d3.select(this.parentNode.parentNode).datum();
return a.hasOwnProperty("count")&&0===a.count?"ppt-segment disabled":"ppt-segment"}).attr("d",function(b){var c=d3.select(this.parentNode.parentNode).datum();return d3.arc().innerRadius(a.graph.node.getDonutInnerRadius(c)).outerRadius(a.graph.node.getDonutOuterRadius(c))(b)}).attr("fill",function(b){var c=d3.select(this.parentNode.parentNode).datum();return a.provider.link.getColor({label:b.label,type:a.graph.link.LinkTypes.RELATION,source:c,target:{label:b.target}},"path","fill")}).attr("stroke",
function(b){var c=d3.select(this.parentNode.parentNode).datum();return a.provider.link.getColor({label:b.label,type:a.graph.link.LinkTypes.RELATION,source:c,target:{label:b.target}},"path","stroke")})};a.graph.node.updateMiddlegroundElements=function(){var b=a.graph.svg.select("#"+a.graph.node.gID).selectAll(".ppt-gnode").selectAll(".ppt-g-node-middleground");b.attr("clip-path",function(a){return"url(#node-view"+a.id+")"});b.selectAll("*").remove();a.graph.node.updateMiddlegroundElementsTooltip(b);
a.graph.node.updateMiddlegroundElementsText(b.filter(function(b){return a.provider.node.getNodeDisplayType(b)===a.provider.node.DisplayTypes.TEXT}));a.graph.node.updateMiddlegroundElementsImage(b.filter(function(b){return a.provider.node.getNodeDisplayType(b)===a.provider.node.DisplayTypes.IMAGE}));a.graph.node.updateMiddlegroundElementsSymbol(b.filter(function(b){return a.provider.node.getNodeDisplayType(b)===a.provider.node.DisplayTypes.SYMBOL}));a.graph.node.updateMiddlegroundElementsSVG(b.filter(function(b){return a.provider.node.getNodeDisplayType(b)===
a.provider.node.DisplayTypes.SVG}));a.graph.node.updateMiddlegroundElementsDisplayedText(b.filter(function(b){return a.provider.node.isTextDisplayed(b)}))};a.graph.node.updateMiddlegroundElementsTooltip=function(b){b.append("title").attr("class",function(b){return a.provider.node.getCSSClass(b,"title")}).text(function(b){return a.provider.node.getTextValue(b,a.graph.node.NODE_TITLE_MAX_CHARS)})};a.graph.node.updateMiddlegroundElementsText=function(b){b.append("circle").attr("r",function(b){return a.provider.node.getSize(b)}).attr("class",
function(b){return a.provider.node.getCSSClass(b,"circle")}).attr("fill",function(b){return a.provider.node.getColor(b,"circle","fill")}).attr("stroke",function(b){return a.provider.node.getColor(b,"circle","stroke")})};a.graph.node.updateMiddlegroundElementsImage=function(b){b.append("circle").attr("r",function(b){return a.provider.node.getSize(b)}).attr("class",function(b){return a.provider.node.getCSSClass(b,"image-background-circle")});b.append("image").attr("class",function(b){return a.provider.node.getCSSClass(b,
"image")}).attr("width",function(b){return a.provider.node.getImageWidth(b)}).attr("height",function(b){return a.provider.node.getImageHeight(b)}).attr("transform",function(b){return"translate("+-a.provider.node.getImageWidth(b)/2+","+-a.provider.node.getImageHeight(b)/2+")"}).attr("xlink:href",function(b){return a.provider.node.getImagePath(b)})};a.graph.node.updateMiddlegroundElementsSymbol=function(b){b.append("circle").attr("r",function(b){return a.provider.node.getSize(b)}).attr("class",function(b){return a.provider.node.getCSSClass(b,
"symbol-background-circle")}).attr("fill",function(b){return a.provider.node.getColor(b,"circle","fill")}).attr("stroke",function(b){return a.provider.node.getColor(b,"circle","stroke")});b.append("use").attr("class",function(b){return a.provider.node.getCSSClass(b,"symbol")}).attr("width",function(b){return a.provider.node.getImageWidth(b)}).attr("height",function(b){return a.provider.node.getImageHeight(b)}).attr("transform",function(b){return"translate("+-a.provider.node.getImageWidth(b)/2+","+
-a.provider.node.getImageHeight(b)/2+")"}).attr("xlink:href",function(b){return a.provider.node.getImagePath(b)}).attr("fill",function(b){return a.provider.node.getColor(b,"circle","fill")}).attr("stroke",function(b){return a.provider.node.getColor(b,"circle","stroke")})};a.graph.node.updateMiddlegroundElementsSVG=function(b){b=b.append("g");b.append("circle").attr("r",function(b){return a.provider.node.getSize(b)}).attr("class","ppt-svg-node-background");var c=b.selectAll("path").data(function(b){return a.provider.node.getSVGPaths(b)});
c.exit().remove();c.enter().append("path");b.selectAll("path").attr("class",function(b){b=d3.select(this.parentNode).datum();return a.provider.node.getCSSClass(b,"path")}).each(function(a,b){for(var c in a)a.hasOwnProperty(c)&&d3.select(this).attr(c,a[c])})};a.graph.node.updateMiddlegroundElementsDisplayedText=function(b){b=b.filter(function(b){return a.provider.node.isTextDisplayed(b)});var c=b.append("rect").attr("fill",function(b){return a.provider.node.getColor(b,"back-text","fill")}).attr("class",
function(b){return a.provider.node.getCSSClass(b,"back-text")});b.append("text").attr("x",0).attr("y",a.graph.node.TEXT_Y).attr("text-anchor","middle").attr("y",a.graph.node.TEXT_Y).attr("class",function(b){return a.provider.node.getCSSClass(b,"text")}).on("mouseover",function(a){d3.select(this.parentNode).attr("clip-path",null)}).on("mouseout",function(a){d3.select(this.parentNode).attr("clip-path",function(a){return"url(#node-view"+a.id+")"})}).text(function(b){return a.provider.node.isTextDisplayed(b)?
a.provider.node.getTextValue(b):""});c.attr("x",function(a){return d3.select(this.parentNode).select("text").node().getBBox().x-3}).attr("y",function(a){return d3.select(this.parentNode).select("text").node().getBBox().y}).attr("rx","5").attr("ry","5").attr("width",function(a){return d3.select(this.parentNode).select("text").node().getBBox().width+6}).attr("height",function(a){return d3.select(this.parentNode).select("text").node().getBBox().height})};a.graph.node.updateForegroundElements=function(){var b=
a.graph.svg.select("#"+a.graph.node.gID).selectAll(".ppt-gnode").selectAll(".ppt-g-node-foreground").selectAll(".ppt-node-foreground-g-arrows");b.classed("active",function(b){return b.valueExpanded&&b.data&&b.data.length>a.graph.node.PAGE_SIZE});b.selectAll(".ppt-larrow").classed("enabled",function(a){return 1<a.page});b.selectAll(".ppt-rarrow").classed("enabled",function(b){return b.data?b.page*a.graph.node.PAGE_SIZE<b.data.length:!1});b=a.graph.svg.select("#"+a.graph.node.gID).selectAll(".ppt-gnode").selectAll(".ppt-g-node-foreground");
b.selectAll(".ppt-count-box").filter(function(b){return b.type!==a.graph.node.NodeTypes.CHOOSE}).classed("root",!0);b.selectAll(".ppt-count-box").filter(function(b){return b.type===a.graph.node.NodeTypes.CHOOSE}).classed("value",!0);b.selectAll(".ppt-count-box").classed("disabled",function(a){return 0===a.count});a.graph.DISABLE_COUNT||b.selectAll(".ppt-count-text").text(function(a){return null!==a.count?a.count:"..."}).classed("disabled",function(a){return 0===a.count});a.graph.svg.select("#"+a.graph.node.gID).selectAll(".ppt-gnode").selectAll(".ppt-g-node-foreground").filter(function(a){return!0===
a.isNegative}).selectAll(".ppt-g-node-ban").attr("transform",function(b){return"translate("+-a.provider.node.getSize(b)+","+-a.provider.node.getSize(b)+") scale("+2*a.provider.node.getSize(b)/100+")"}).attr("stroke-width",function(b){return 2/(2*a.provider.node.getSize(b)/100)+"px"});a.graph.svg.select("#"+a.graph.node.gID).selectAll(".ppt-gnode").selectAll(".ppt-g-node-foreground").selectAll(".ppt-g-node-ban").classed("active",function(a){return!0===a.isNegative})};a.graph.node.segmentClick=function(b){d3.event.preventDefault();
var c=d3.select(this.parentNode.parentNode).datum();a.graph.ignoreCount=!0;a.graph.addRelationshipData(c,b,function(){a.graph.ignoreCount=!1;a.graph.hasGraphChanged=!0;a.update()})};a.graph.node.mouseOverNode=function(){d3.event.preventDefault();var b=d3.select(this).data()[0];a.queryviewer.isActive&&(a.queryviewer.queryConstraintSpanElements.filter(function(a){return a.ref===b}).classed("hover",!0),a.queryviewer.querySpanElements.filter(function(a){return a.ref===b}).classed("hover",!0));a.cypherviewer.isActive&&
a.cypherviewer.querySpanElements.filter(function(a){return a.node===b}).classed("hover",!0)};a.graph.node.mouseOutNode=function(){d3.event.preventDefault();var b=d3.select(this).data()[0];a.queryviewer.isActive&&(a.queryviewer.queryConstraintSpanElements.filter(function(a){return a.ref===b}).classed("hover",!1),a.queryviewer.querySpanElements.filter(function(a){return a.ref===b}).classed("hover",!1));a.cypherviewer.isActive&&a.cypherviewer.querySpanElements.filter(function(a){return a.node===b}).classed("hover",
!1)};a.graph.node.nodeClick=function(){if(!d3.event.defaultPrevented){var b=d3.select(this).data()[0];a.logger.debug("nodeClick ("+b.label+")");if(b.type===a.graph.node.NodeTypes.VALUE)a.graph.node.valueNodeClick(b);else if(b.type===a.graph.node.NodeTypes.CHOOSE||b.type===a.graph.node.NodeTypes.ROOT)if(d3.event.ctrlKey){if(b.type===a.graph.node.NodeTypes.CHOOSE){b.isNegative=!b.hasOwnProperty("isNegative")||!b.isNegative;a.graph.node.collapseAllNode();if(!(b.hasOwnProperty("value")&&0<b.value.length)&&
b.isNegative){for(var c=a.graph.links.length-1;0<=c;c--)a.graph.links[c].source===b&&a.graph.node.removeNode(a.graph.links[c].target);b.count=0}a.result.hasChanged=!0;a.graph.hasGraphChanged=!0;a.update()}}else b.valueExpanded?a.graph.node.collapseNode(b):a.graph.node.chooseNodeClick(b)}};a.graph.node.collapseNode=function(b){if(b.valueExpanded){a.logger.debug("collapseNode ("+b.label+")");a.graph.notifyListeners(a.graph.Events.GRAPH_NODE_VALUE_COLLAPSE,[b]);var c=a.graph.links.filter(function(c){return c.source===
b&&c.type===a.graph.link.LinkTypes.VALUE});c.forEach(function(b){a.graph.nodes.splice(a.graph.nodes.indexOf(b.target),1)});for(var d=a.graph.links.length-1;0<=d;d--)0<=c.indexOf(a.graph.links[d])&&a.graph.links.splice(d,1);b.type!==a.graph.node.NodeTypes.ROOT&&(b.fixed=!1,b.fx=null,b.fy=null);b.parent&&b.parent.type!==a.graph.node.NodeTypes.ROOT&&(b.parent.fixed=!1,b.parent.fx=null,b.parent.fy=null);b.valueExpanded=!1;b.valueExpanded.fx=null;b.valueExpanded.fy=null;a.update()}else a.logger.debug("collapseNode called on an unexpanded node")};
a.graph.node.collapseAllNode=function(){a.graph.nodes.forEach(function(b){b.type!==a.graph.node.NodeTypes.CHOOSE&&b.type!==a.graph.node.NodeTypes.ROOT||!b.valueExpanded||a.graph.node.collapseNode(b)})};a.graph.node.valueNodeClick=function(b){a.logger.debug("valueNodeClick ("+b.label+")");a.graph.notifyListeners(a.graph.Events.GRAPH_NODE_ADD_VALUE,[b]);void 0===b.parent.value&&(b.parent.value=[]);b.parent.value.push(b);a.result.hasChanged=!0;a.graph.hasGraphChanged=!0;a.graph.node.collapseNode(b.parent)};
a.graph.node.chooseNodeClick=function(b){a.logger.debug("chooseNodeClick ("+b.label+") with waiting state set to "+a.graph.node.chooseWaiting);if(!a.graph.node.chooseWaiting&&!b.immutable&&0!==b.count)if(a.graph.node.collapseAllNode(),a.graph.node.chooseWaiting=!0,void 0!==b.data&&b.isAutoLoadValue)b.page=1,a.graph.node.expandNode(b),a.graph.node.chooseWaiting=!1;else{a.logger.info("Values ("+b.label+") ==>");var c=a.query.generateNodeValueQuery(b);a.rest.post({statements:[{statement:c.statement,
parameters:c.parameters}]}).done(function(c){a.logger.info("<== Values ("+b.label+")");c=a.rest.response.parse(c);var d=a.provider.node.getConstraintAttribute(b.label);b.data=c[0].filter(function(a){var c=!0;b.hasOwnProperty("value")&&0<b.value.length&&b.value.forEach(function(b){b.attributes[d]===a[d]&&(c=!1)});return c});b.page=1;a.graph.node.expandNode(b);a.graph.node.chooseWaiting=!1}).fail(function(b,c,f){a.graph.node.chooseWaiting=!1;a.logger.error(c+': error while accessing Neo4j server on URL:"'+
a.rest.CYPHER_URL+'" defined in "popoto.rest.CYPHER_URL" property: '+f)})}};a.graph.node.addExpandedValue=function(b,c){for(var d=!1,e=a.graph.nodes.length-1;0<=e;e--)if(a.graph.nodes[e].valueExpanded){for(var f=a.graph.nodes[e].data.length-1;0<=f;f--)a.graph.nodes[e].data[f][b]===c&&(d=!0,a.graph.nodes[e].hasOwnProperty("value")||(a.graph.nodes[e].value=[]),a.graph.nodes[e].value.push({attributes:a.graph.nodes[e].data[f]}),a.graph.nodes[e].data.splice(f,1));a.graph.node.collapseNode(a.graph.nodes[e]);
a.graph.node.expandNode(a.graph.nodes[e])}d&&(a.result.hasChanged=!0,a.graph.hasGraphChanged=!0,a.update())};a.graph.node.getContainingValue=function(b){var c=[],d=a.graph.links,e=a.graph.nodes;0<e.length&&(e=e[0],void 0!==e.value&&0<e.value.length&&(void 0!==b&&b!==e.label||c.push(e)),d.forEach(function(d){var e=d.target;d.type===a.graph.link.LinkTypes.RELATION&&void 0!==e.value&&0<e.value.length&&(void 0!==b&&b!==e.label||c.push(e))}));return c};a.graph.node.addValueForLabel=function(b,c){for(var d=
!1,e=a.graph.nodes.length-1;0<=e;e--)if(a.graph.nodes[e].type===a.graph.node.NodeTypes.CHOOSE&&a.graph.nodes[e].label===b){a.graph.nodes[e].hasOwnProperty("value")||(a.graph.nodes[e].value=[]);var f=!1,g=a.provider.node.getConstraintAttribute(b);a.graph.nodes[e].value.forEach(function(a){a.attributes.hasOwnProperty(g)&&a.attributes[g]===c.attributes[g]&&(f=!0)});f||(a.graph.nodes[e].value.push(c),d=!0)}return d};a.graph.node.addValue=function(b,c){for(var d=!1,e=0;e<a.graph.nodes.length;e++){var f=
a.graph.nodes[e];if(0<=b.indexOf(f.id)){f.hasOwnProperty("value")||(f.value=[]);var g=a.provider.node.getReturnAttributes(f.label)[0];f.data.forEach(function(a){a.hasOwnProperty(g)&&a[g]===c&&(d=!0,f.value.push({attributes:a}))})}}d&&(a.result.hasChanged=!0,a.graph.hasGraphChanged=!0,a.update())};a.graph.node.removeValue=function(b,c){for(var d=!1,e=b.value.length-1;0<=e;e--)b.value[e]===c&&(a.graph.node.collapseNode(b),b.value.splice(e,1),d=!0);return d};a.graph.node.getValue=function(b,c){for(var d=
0;d<a.graph.nodes.length;d++){var e=a.graph.nodes[d];if(e.id===b)for(var f=a.provider.node.getConstraintAttribute(e.label),g=e.value.length-1;0<=g;g--)if(e.value[g].attributes[f]===c)return e.value[g]}};a.graph.node.removeExpandedValue=function(b,c){for(var d=!1,e=a.graph.nodes.length-1;0<=e;e--)if(a.graph.nodes[e].valueExpanded){for(var f=[],g=a.graph.nodes[e].value.length-1;0<=g;g--)a.graph.nodes[e].value[g].attributes[b]===c&&(d=!0,f=f.concat(a.graph.nodes[e].value.splice(g,1)));for(g=0;g<f.length;g++)a.graph.nodes[e].data.push(f[g].attributes);
a.graph.node.collapseNode(a.graph.nodes[e]);a.graph.node.expandNode(a.graph.nodes[e])}d&&(a.result.hasChanged=!0,a.graph.hasGraphChanged=!0,a.update())};a.graph.node.getAutoLoadValueNodes=function(){return a.graph.nodes.filter(function(a){return a.hasOwnProperty("isAutoLoadValue")&&!0===a.isAutoLoadValue&&!0!==a.isNegative})};a.graph.node.addRelatedValues=function(b,c,d){c=a.graph.node.filterExistingValues(b,c);if(!(0>=c.length)){var e=[];c.forEach(function(b){var c=a.provider.node.getConstraintAttribute(b.label),
d="MATCH ",d=c===a.query.NEO4J_INTERNAL_ID?d+("(v:`"+b.label+"`) WHERE (ID(v) = $p)"):d+("(v:`"+b.label+"`) WHERE (v."+c+" = $p)"),c=a.provider.node.getReturnAttributes(b.label),f="",d=d+(' RETURN DISTINCT "'+b.rel+'" AS rel, "'+b.label+'" AS label, {'+c.reduce(function(a,b){a+=f+b+":v."+b;f=", ";return a},"")+"} AS value LIMIT 1");e.push({statement:d,parameters:{p:b.id},resultDataContents:["row"]})});a.logger.info("addRelatedValues ==>");a.rest.post({statements:e}).done(function(c){a.logger.info("<== addRelatedValues");
var e=a.rest.response.parse(c),f=0;e.forEach(function(c){if(0<c.length){var g=c[0].label,h=c[0].value,l=c[0].rel;c={id:a.graph.generateId(),parent:b,attributes:h,type:a.graph.node.NodeTypes.VALUE,label:g};a.graph.ignoreCount=!0;var h=b.relationships.filter(function(a){return a.label===l&&a.target===g}),q={label:l,target:g};0<h.length&&(q=h[0]);a.graph.addRelationshipData(b,q,function(){f++;f===e.length&&(a.graph.ignoreCount=!1,a.graph.hasGraphChanged=!0,a.result.hasChanged=!0,a.update())},[c],d)}})}).fail(function(a,
b,c){console.error(a,b,c)})}};a.graph.node.addRelatedBranch=function(b,c,d,e){if(0<c.length){var f=c[0];c=c.slice(1);var g=b.relationships.filter(function(a){return a.label===f.type&&a.target===f.target});0<g.length&&a.graph.addRelationshipData(b,g[0],function(b){a.graph.node.addRelatedBranch(b,c,d,e)})}else a.graph.node.addRelatedValues(b,d,e)};a.graph.node.filterExistingValues=function(b,c){var d=[],e=a.graph.nodes.filter(function(a){return a.parent===b&&a.hasOwnProperty("value")&&0<a.value.length});
c.forEach(function(b){var c=!1,f=a.provider.node.getConstraintAttribute(b.label);e.forEach(function(a){a.label===b.label&&a.value.forEach(function(a){a.attributes[f]===b.id&&(c=!0)})});c||d.push(b)});return d};a.graph.computeParentAngle=function(a){var b=0;if(a.parent){var b=a.parent.x,d=a.parent.y,e=a.x;a=a.y;var f=100/(Math.sqrt(Math.pow(b-e,2)+Math.pow(d-a,2))-100),b=((e+f*b)/(1+f)-e)/100;-1>b&&(b=-1);1<b&&(b=1);b=Math.acos(b);d>a&&(b=2*Math.PI-b)}return b};a.graph.node.expandNode=function(b){a.graph.notifyListeners(a.graph.Events.GRAPH_NODE_VALUE_EXPAND,
[b]);var c=b.page*a.graph.node.PAGE_SIZE,d=b.data.slice(c-a.graph.node.PAGE_SIZE,c),e=a.graph.computeParentAngle(b),f=1;d.forEach(function(c){var g;g=b.parent?360/(d.length+1)*f:360/d.length*f;var l=b.x+100*Math.cos(Math.PI/180*g-e);g=b.y+100*Math.sin(Math.PI/180*g-e);c={id:a.graph.generateId(),parent:b,attributes:c,type:a.graph.node.NodeTypes.VALUE,label:b.label,count:c.count,x:l,y:g,internalID:c[a.query.NEO4J_INTERNAL_ID.queryInternalName]};a.graph.nodes.push(c);a.graph.links.push({id:"l"+a.graph.generateId(),
source:b,target:c,type:a.graph.link.LinkTypes.VALUE});f++});b.fixed=!0;b.fx=b.x;b.fy=b.y;b.parent&&b.parent.type!==a.graph.node.NodeTypes.ROOT&&(b.parent.fixed=!0,b.parent.fx=b.parent.x,b.parent.fy=b.parent.y);b.valueExpanded=!0;a.update()};a.graph.node.loadRelationshipData=function(b,c,d){var e=a.provider.node.getSchema(b.label);void 0!==e?e.hasOwnProperty("rel")&&0<e.rel.length?c(a.graph.node.pie.startAngle(d-Math.PI).endAngle(d+Math.PI)(e.rel).map(function(a){var b={id:a.data.label+a.data.target.label,
label:a.data.label,target:a.data.target.label,count:0,startAngle:a.startAngle,endAngle:a.endAngle,directionAngle:(a.startAngle+a.endAngle)/2};!0===a.data.isReverse&&(b.isReverse=!0);return b})):c([]):(e=a.query.generateNodeRelationQuery(b),a.logger.info("Relations ("+b.label+") ==>"),a.rest.post({statements:[{statement:e.statement,parameters:e.parameters}]}).done(function(e){a.logger.info("<== Relations ("+b.label+")");e=a.rest.response.parse(e)[0].filter(function(b){return a.query.filterRelation(b)});
e=a.graph.node.pie.startAngle(d-Math.PI).endAngle(d+Math.PI)(e).map(function(a){return{id:a.data.label+a.data.target,label:a.data.label,target:a.data.target,count:a.data.count,startAngle:a.startAngle,endAngle:a.endAngle,directionAngle:(a.startAngle+a.endAngle)/2}});c(e)}).fail(function(b,d,e){a.logger.error(d+': error while accessing Neo4j server on URL:"'+a.rest.CYPHER_URL+'" defined in "popoto.rest.CYPHER_URL" property: '+e);c([])}))};a.graph.node.expandRelationships=function(b,c){var d=0;if(b.hasOwnProperty("relationships")&&
0<b.relationships.length)for(var e=0;e<b.relationships.length;e++)a.graph.addRelationshipData(b,b.relationships[e],function(){d++;d===b.relationships.length&&c()});else c()};a.graph.addRelationshipData=function(b,c,d,e,f){var g={id:""+a.graph.generateId(),parent:b,parentRel:c.label,type:a.graph.node.NodeTypes.CHOOSE,label:c.target,fixed:!1,internalLabel:a.graph.node.generateInternalLabel(c.target),relationships:[]};!0===c.isReverse&&(g.isParentRelReverse=!0);void 0!==e&&0<e.length&&(g.value=e);void 0!==
f&&!0===f&&(g.isNegative=!0);e={id:"l"+a.graph.generateId(),source:b,target:g,type:a.graph.link.LinkTypes.RELATION,label:c.label};g.x=b.x+2*a.provider.link.getDistance(e)/3*Math.cos(c.directionAngle-Math.PI/2)+10*Math.random();g.y=b.y+2*a.provider.link.getDistance(e)/3*Math.sin(c.directionAngle-Math.PI/2)+10*Math.random();g.tx=b.tx+a.provider.link.getDistance(e)*Math.cos(c.directionAngle-Math.PI/2);g.ty=b.ty+a.provider.link.getDistance(e)*Math.sin(c.directionAngle-Math.PI/2);a.graph.nodes.push(g);
a.graph.links.push(e);a.graph.hasGraphChanged=!0;a.updateGraph();a.graph.node.loadRelationshipData(g,function(b){g.relationships=b;a.graph.hasGraphChanged=!0;a.updateGraph();a.provider.node.getIsAutoExpandRelations(g.label)?a.graph.node.expandRelationships(g,function(){d(g)}):d(g)},c.directionAngle)};a.graph.node.removeNode=function(b){var c=b.hasOwnProperty("value")&&0<b.value.length;a.graph.links.filter(function(a){return a.source===b}).forEach(function(b){b=a.graph.node.removeNode(b.target);c=
c||b});for(var d=a.graph.links.length-1;0<=d;d--)a.graph.links[d].target===b&&a.graph.links.splice(d,1);a.graph.nodes.splice(a.graph.nodes.indexOf(b),1);return c};a.graph.node.clearSelection=function(){d3.event.preventDefault();var b=d3.select(this).data()[0];a.graph.node.collapseAllNode();if(void 0!==b.value&&0<b.value.length&&!b.immutable){b.value.pop();if(!0===b.isNegative&&0===b.value.length){for(var c=a.graph.links.length-1;0<=c;c--)a.graph.links[c].source===b&&a.graph.node.removeNode(a.graph.links[c].target);
b.count=0}a.result.hasChanged=!0;a.graph.hasGraphChanged=!0;a.update()}};a.queryviewer={};a.queryviewer.containerId="popoto-query";a.queryviewer.QUERY_STARTER="I'm looking for";a.queryviewer.CHOOSE_LABEL="choose";a.queryviewer.createQueryArea=function(){var b="#"+a.queryviewer.containerId;a.queryviewer.queryConstraintSpanElements=d3.select(b).append("p").attr("class","ppt-query-constraint-elements").selectAll(".queryConstraintSpan");a.queryviewer.querySpanElements=d3.select(b).append("p").attr("class",
"ppt-query-elements").selectAll(".querySpan")};a.queryviewer.updateQuery=function(){a.queryviewer.queryConstraintSpanElements=a.queryviewer.queryConstraintSpanElements.data([]);a.queryviewer.querySpanElements=a.queryviewer.querySpanElements.data([]);a.queryviewer.queryConstraintSpanElements.exit().remove();a.queryviewer.querySpanElements.exit().remove();a.queryviewer.queryConstraintSpanElements=a.queryviewer.queryConstraintSpanElements.data(a.queryviewer.generateConstraintData(a.graph.links,a.graph.nodes));
a.queryviewer.querySpanElements=a.queryviewer.querySpanElements.data(a.queryviewer.generateData(a.graph.links,a.graph.nodes));a.queryviewer.queryConstraintSpanElements=a.queryviewer.queryConstraintSpanElements.enter().append("span").on("contextmenu",a.queryviewer.rightClickSpan).on("click",a.queryviewer.clickSpan).on("mouseover",a.queryviewer.mouseOverSpan).on("mouseout",a.queryviewer.mouseOutSpan).merge(a.queryviewer.queryConstraintSpanElements);a.queryviewer.querySpanElements=a.queryviewer.querySpanElements.enter().append("span").on("contextmenu",
a.queryviewer.rightClickSpan).on("click",a.queryviewer.clickSpan).on("mouseover",a.queryviewer.mouseOverSpan).on("mouseout",a.queryviewer.mouseOutSpan).merge(a.queryviewer.querySpanElements);a.queryviewer.queryConstraintSpanElements.attr("id",function(a){return a.id}).attr("class",function(b){return b.isLink?"ppt-span-link":b.type===a.graph.node.NodeTypes.ROOT?"ppt-span-root":b.type===a.graph.node.NodeTypes.CHOOSE?void 0!==b.ref.value&&0<b.ref.value.length?"ppt-span-value":"ppt-span-choose":b.type===
a.graph.node.NodeTypes.VALUE?"ppt-span-value":b.type===a.graph.node.NodeTypes.GROUP?"ppt-span-group":"ppt-span"}).text(function(a){return a.term+" "});a.queryviewer.querySpanElements.attr("id",function(a){return a.id}).attr("class",function(b){return b.isLink?"ppt-span-link":b.type===a.graph.node.NodeTypes.ROOT?"ppt-span-root":b.type===a.graph.node.NodeTypes.CHOOSE?void 0!==b.ref.value&&0<b.ref.value.length?"ppt-span-value":"ppt-span-choose":b.type===a.graph.node.NodeTypes.VALUE?"ppt-span-value":
b.type===a.graph.node.NodeTypes.GROUP?"ppt-span-group":"ppt-span"}).text(function(a){return a.term+" "})};a.queryviewer.generateConstraintData=function(b,c){var d=[],e=0;d.push({id:e++,term:a.queryviewer.QUERY_STARTER});0<c.length&&d.push({id:e++,type:c[0].type,term:a.provider.node.getSemanticValue(c[0]),ref:c[0]});b.forEach(function(b){var c=b.source,f=b.target;b.type===a.graph.link.LinkTypes.RELATION&&f.type!==a.graph.node.NodeTypes.GROUP&&void 0!==f.value&&0<f.value.length&&(c.type===a.graph.node.NodeTypes.GROUP&&
d.push({id:e++,type:c.type,term:a.provider.node.getSemanticValue(c),ref:c}),d.push({id:e++,isLink:!0,term:a.provider.link.getSemanticValue(b),ref:b}),f.type!==a.graph.node.NodeTypes.GROUP&&(void 0!==f.value&&0<f.value.length?d.push({id:e++,type:f.type,term:a.provider.node.getSemanticValue(f),ref:f}):d.push({id:e++,type:f.type,term:"<"+a.queryviewer.CHOOSE_LABEL+" "+a.provider.node.getSemanticValue(f)+">",ref:f})))});return d};a.queryviewer.generateData=function(b,c){var d=[],e=[],f=0;b.forEach(function(b){var c=
b.source,g=b.target;g.type===a.graph.node.NodeTypes.GROUP&&e.push({id:f++,type:g.type,term:a.provider.node.getSemanticValue(g),ref:g});b.type!==a.graph.link.LinkTypes.RELATION||g.type===a.graph.node.NodeTypes.GROUP||void 0!==g.value&&0!==g.value.length||(c.type===a.graph.node.NodeTypes.GROUP&&d.push({id:f++,type:c.type,term:a.provider.node.getSemanticValue(c),ref:c}),d.push({id:f++,isLink:!0,term:a.provider.link.getSemanticValue(b),ref:b}),g.type!==a.graph.node.NodeTypes.GROUP&&d.push({id:f++,type:g.type,
term:"<"+a.queryviewer.CHOOSE_LABEL+" "+a.provider.node.getSemanticValue(g)+">",ref:g}))});return d.concat(e)};a.queryviewer.mouseOverSpan=function(){d3.select(this).classed("hover",function(a){return a.ref});var b=d3.select(this).data()[0];if(b.ref){var c=a.graph.svg.selectAll("#"+a.graph.link.gID+" > g").filter(function(a){return a===b.ref});c.select("path").classed("ppt-link-hover",!0);c.select("text").classed("ppt-link-hover",!0);a.graph.svg.selectAll("#"+a.graph.node.gID+" > g").filter(function(a){return a===
b.ref}).select(".ppt-g-node-background").selectAll("circle").transition().style("fill-opacity",.5);a.cypherviewer.isActive&&a.cypherviewer.querySpanElements.filter(function(a){return a.node===b.ref||a.link===b.ref}).classed("hover",!0)}};a.queryviewer.rightClickSpan=function(){var b=d3.select(this).data()[0];if(!b.isLink&&b.ref){var c=a.graph.svg.selectAll("#"+a.graph.node.gID+" > g").filter(function(a){return a===b.ref});c.on("contextmenu").call(c.node(),b.ref)}};a.queryviewer.clickSpan=function(){var b=
d3.select(this).data()[0];if(!b.isLink&&b.ref){var c=a.graph.svg.selectAll("#"+a.graph.node.gID+" > g").filter(function(a){return a===b.ref});c.on("click").call(c.node(),b.ref)}};a.queryviewer.mouseOutSpan=function(){d3.select(this).classed("hover",!1);var b=d3.select(this).data()[0];if(b.ref){var c=a.graph.svg.selectAll("#"+a.graph.link.gID+" > g").filter(function(a){return a===b.ref});c.select("path").classed("ppt-link-hover",!1);c.select("text").classed("ppt-link-hover",!1);a.graph.svg.selectAll("#"+
a.graph.node.gID+" > g").filter(function(a){return a===b.ref}).select(".ppt-g-node-background").selectAll("circle").transition().style("fill-opacity",0);a.cypherviewer.isActive&&a.cypherviewer.querySpanElements.filter(function(a){return a.node===b.ref||a.link===b.ref}).classed("hover",!1)}};a.cypherviewer={};a.cypherviewer.containerId="popoto-cypher";a.cypherviewer.MATCH="MATCH";a.cypherviewer.RETURN="RETURN";a.cypherviewer.WHERE="WHERE";a.cypherviewer.QueryElementTypes=Object.freeze({KEYWORD:0,NODE:1,
SEPARATOR:2,SOURCE:3,LINK:4,TARGET:5,RETURN:6,WHERE:7});a.cypherviewer.createQueryArea=function(){a.cypherviewer.querySpanElements=d3.select("#"+a.cypherviewer.containerId).append("p").attr("class","ppt-query-constraint-elements").selectAll(".queryConstraintSpan")};a.cypherviewer.updateQuery=function(){a.cypherviewer.querySpanElements=a.cypherviewer.querySpanElements.data([]);a.cypherviewer.querySpanElements.exit().remove();a.cypherviewer.querySpanElements=a.cypherviewer.querySpanElements.data(a.cypherviewer.generateData(a.graph.links,
a.graph.nodes));a.cypherviewer.querySpanElements=a.cypherviewer.querySpanElements.enter().append("span").attr("id",function(a){return"cypher-"+a.id}).on("mouseover",a.cypherviewer.mouseOverSpan).on("mouseout",a.cypherviewer.mouseOutSpan).on("contextmenu",a.cypherviewer.rightClickSpan).on("click",a.cypherviewer.clickSpan).merge(a.cypherviewer.querySpanElements);a.cypherviewer.querySpanElements.filter(function(b){return b.type===a.cypherviewer.QueryElementTypes.KEYWORD}).attr("class","ppt-span").text(function(a){return" "+
a.value+" "});a.cypherviewer.querySpanElements.filter(function(b){return b.type===a.cypherviewer.QueryElementTypes.SEPARATOR}).attr("class","ppt-span").text(function(a){return a.value+" "});a.cypherviewer.querySpanElements.filter(function(b){return b.type===a.cypherviewer.QueryElementTypes.NODE}).attr("class",function(a){return void 0!==a.node.value&&0<a.node.value.length?"ppt-span-root-value":"ppt-span-root"}).text(function(a){return"("+a.node.internalLabel+":`"+a.node.label+"`)"});a.cypherviewer.querySpanElements.filter(function(b){return b.type===
a.cypherviewer.QueryElementTypes.SOURCE}).attr("class",function(b){return b.node===a.graph.getRootNode()?void 0!==b.node.value&&0<b.node.value.length?"ppt-span-root-value":"ppt-span-root":void 0!==b.node.value&&0<b.node.value.length?"ppt-span-value":"ppt-span-choose"}).text(function(a){a=a.node;return"("+a.internalLabel+":`"+a.label+"`)"});a.cypherviewer.querySpanElements.filter(function(b){return b.type===a.cypherviewer.QueryElementTypes.LINK}).attr("class","ppt-span-link").text(function(b){return!0===
b.link.target.isParentRelReverse?"<-[:`"+b.link.label+"`]-":"-[:`"+b.link.label+"`]-"+(a.query.USE_RELATION_DIRECTION?">":"")});a.cypherviewer.querySpanElements.filter(function(b){return b.type===a.cypherviewer.QueryElementTypes.TARGET}).attr("class",function(a){return void 0!==a.node.value&&0<a.node.value.length?"ppt-span-value":"ppt-span-choose"}).text(function(a){return"("+a.node.internalLabel+":`"+a.node.label+"`)"});a.cypherviewer.querySpanElements.filter(function(b){return b.type===a.cypherviewer.QueryElementTypes.WHERE}).attr("class",
function(b){return b.node===a.graph.getRootNode()?"ppt-span-root-value":"ppt-span-value"}).text(function(b){var c=b.node;if(!0===c.isNegative){if(!c.hasOwnProperty("value")||0>=c.value.length)return"(NOT ("+b.link.source.internalLabel+":`"+b.link.source.label+"`)-[:`"+b.link.label+"`]->(:`"+b.link.target.label+"`))";var d=[],e=a.provider.node.getConstraintAttribute(c.label);c.value.forEach(function(a){d.push("(NOT ("+b.link.source.internalLabel+":`"+b.link.source.label+"`)-[:`"+b.link.label+"`]->(:`"+
b.link.target.label+"`{"+e+":"+a.attributes[e]+"}))")});return d.join(" AND ")}var f=a.provider.node.getConstraintAttribute(c.label),g="",h="",g=f===a.query.NEO4J_INTERNAL_ID?g+(c.internalLabel+".id"):g+(c.internalLabel+"."+f),g=c.hasOwnProperty("value")&&1<c.value.length?g+" IN [":g+" = ";c.value.forEach(function(b){g+=h;h=", ";f===a.query.NEO4J_INTERNAL_ID?g+=b.internalID:(b=b.attributes[f],g="boolean"===typeof b||"number"===typeof b?g+b:g+('"'+b+'"'))});1<c.value.length&&(g+="]");return"("+g+")"});
a.cypherviewer.querySpanElements.filter(function(b){return b.type===a.cypherviewer.QueryElementTypes.RETURN}).attr("class",function(a){return void 0!==a.node.value&&0<a.node.value.length?"ppt-span-root-value":"ppt-span-root"}).text(function(a){return a.node.internalLabel})};a.cypherviewer.generateData=function(b){var c=[],d=0,e=a.graph.getRootNode();b=a.query.getRelevantLinks(e,e,b);var f=b.filter(function(a){return!0===a.target.isNegative&&(!a.target.hasOwnProperty("value")||0>=a.target.value.length)});
c.push({id:d++,type:a.cypherviewer.QueryElementTypes.KEYWORD,value:a.cypherviewer.MATCH});e&&c.push({id:d++,type:a.cypherviewer.QueryElementTypes.NODE,node:e});0<b.length&&b.length>f.length&&c.push({id:d++,type:a.cypherviewer.QueryElementTypes.SEPARATOR,value:","});for(f=0;f<b.length;f++){var g=b[f];if(!0!==g.target.isNegative||g.target.hasOwnProperty("value")&&!(0>=g.target.value.length))c.push({id:d++,type:a.cypherviewer.QueryElementTypes.SOURCE,node:g.source}),c.push({id:d++,type:a.cypherviewer.QueryElementTypes.LINK,
link:g}),c.push({id:d++,type:a.cypherviewer.QueryElementTypes.TARGET,node:g.target}),f<b.length-1&&c.push({id:d++,type:a.cypherviewer.QueryElementTypes.SEPARATOR,value:","})}(e&&void 0!==e.value&&0<e.value.length||0<b.length)&&c.push({id:d++,type:a.cypherviewer.QueryElementTypes.KEYWORD,value:a.cypherviewer.WHERE});e&&void 0!==e.value&&0<e.value.length&&(c.push({id:d++,type:a.cypherviewer.QueryElementTypes.WHERE,node:e}),0<b.length&&c.push({id:d++,type:a.cypherviewer.QueryElementTypes.SEPARATOR,value:" AND "}));
for(var h=!1,f=0;f<b.length;f++)g=b[f],!0===g.target.isNegative?(h&&c.push({id:d++,type:a.cypherviewer.QueryElementTypes.SEPARATOR,value:" AND "}),c.push({id:d++,type:a.cypherviewer.QueryElementTypes.WHERE,node:g.target,link:g}),h=!0):void 0!==g.target.value&&0<g.target.value.length&&(h&&c.push({id:d++,type:a.cypherviewer.QueryElementTypes.SEPARATOR,value:" AND "}),c.push({id:d++,type:a.cypherviewer.QueryElementTypes.WHERE,node:g.target}),h=!0);c.push({id:d++,type:a.cypherviewer.QueryElementTypes.KEYWORD,
value:a.cypherviewer.RETURN});e&&c.push({id:d++,type:a.cypherviewer.QueryElementTypes.RETURN,node:e});return c};a.cypherviewer.mouseOverSpan=function(){var b=d3.select(this).data()[0];if(b.node)a.cypherviewer.querySpanElements.filter(function(a){return a.node===b.node}).classed("hover",!0),a.graph.svg.selectAll("#"+a.graph.node.gID+" > g").filter(function(a){return a===b.node}).select(".ppt-g-node-background").selectAll("circle").transition().style("fill-opacity",.5),a.queryviewer.isActive&&(a.queryviewer.queryConstraintSpanElements.filter(function(a){return a.ref===
b.node}).classed("hover",!0),a.queryviewer.querySpanElements.filter(function(a){return a.ref===b.node}).classed("hover",!0));else if(b.link){d3.select(this).classed("hover",!0);var c=a.graph.svg.selectAll("#"+a.graph.link.gID+" > g").filter(function(a){return a===b.link});c.select("path").classed("ppt-link-hover",!0);c.select("text").classed("ppt-link-hover",!0)}};a.cypherviewer.mouseOutSpan=function(){var b=d3.select(this).data()[0];if(b.node)a.cypherviewer.querySpanElements.filter(function(a){return a.node===
b.node}).classed("hover",!1),a.graph.svg.selectAll("#"+a.graph.node.gID+" > g").filter(function(a){return a===b.node}).select(".ppt-g-node-background").selectAll("circle").transition().style("fill-opacity",0),a.queryviewer.isActive&&(a.queryviewer.queryConstraintSpanElements.filter(function(a){return a.ref===b.node}).classed("hover",!1),a.queryviewer.querySpanElements.filter(function(a){return a.ref===b.node}).classed("hover",!1));else if(b.link){d3.select(this).classed("hover",!1);var c=a.graph.svg.selectAll("#"+
a.graph.link.gID+" > g").filter(function(a){return a===b.link});c.select("path").classed("ppt-link-hover",!1);c.select("text").classed("ppt-link-hover",!1)}};a.cypherviewer.clickSpan=function(){var b=d3.select(this).data()[0];if(b.node){var c=a.graph.svg.selectAll("#"+a.graph.node.gID+" > g").filter(function(a){return a===b.node});c.on("click").call(c.node(),b.node)}};a.cypherviewer.rightClickSpan=function(){var b=d3.select(this).data()[0];if(b.node){var c=a.graph.svg.selectAll("#"+a.graph.node.gID+
" > g").filter(function(a){return a===b.node});c.on("contextmenu").call(c.node(),b.node)}};a.query={};a.query.MAX_RESULTS_COUNT=100;a.query.VALUE_QUERY_LIMIT=100;a.query.USE_PARENT_RELATION=!1;a.query.USE_RELATION_DIRECTION=!0;a.query.COLLECT_RELATIONS_WITH_VALUES=!1;a.query.prefilter="";a.query.NEO4J_INTERNAL_ID=Object.freeze({queryInternalName:"NEO4JID"});a.query.filterRelation=function(a){return!0};a.query.generateTaxonomyCountQuery=function(b){var c=a.provider.node.getConstraintAttribute(b),d=
[];a.provider.node.getPredefinedConstraints(b).forEach(function(a){d.push(a.replace(RegExp("\\$identifier","g"),"n"))});return c===a.query.NEO4J_INTERNAL_ID?"MATCH (n:`"+b+"`)"+(0<d.length?" WHERE "+d.join(" AND "):"")+" RETURN count(DISTINCT ID(n)) as count":"MATCH (n:`"+b+"`)"+(0<d.length?" WHERE "+d.join(" AND "):"")+" RETURN count(DISTINCT n."+c+") as count"};a.query.generateQueryElements=function(b,c,d,e){var f=[],g=[],h=[],l=[],k={};a.provider.node.getPredefinedConstraints(b.label).forEach(function(a){g.push(a.replace(RegExp("\\$identifier",
"g"),b.internalLabel))});f.push("("+b.internalLabel+":`"+b.label+"`)");if(e||b.immutable){var m=a.query.generateNodeValueConstraints(b),g=g.concat(m.whereElements),p;for(p in m.parameters)m.parameters.hasOwnProperty(p)&&(k[p]=m.parameters[p])}var q=0;d.forEach(function(b){var d=b.source,n=b.target,m="->";a.query.USE_RELATION_DIRECTION&&!0!==n.isParentRelReverse||(m="-");var p="r"+q++;h.push(p);a.provider.node.getPredefinedConstraints(n.label).forEach(function(a){g.push(a.replace(RegExp("\\$identifier",
"g"),n.internalLabel))});if(n!==c&&!0===n.isNegative)if(void 0!==n.value&&0<n.value.length){var r=0;n.value.forEach(function(c){c=a.provider.node.getConstraintAttribute(c.label);var e;0===r?(e=n.internalLabel+"_"+c,r++):e=n.internalLabel+"_"+c+r++;g.push("(NOT ("+d.internalLabel+":`"+d.label+"`)-[:`"+b.label+"`]"+m+"(:`"+n.label+"`{"+c+":$"+e+"}) )")})}else g.push("(NOT ("+d.internalLabel+":`"+d.label+"`)-[:`"+b.label+"`]"+m+"(:`"+n.label+"`) )");else a.query.COLLECT_RELATIONS_WITH_VALUES&&n===c&&
l.push("COLLECT("+p+") AS incomingRels"),f.push("("+d.internalLabel+":`"+d.label+"`)-["+p+":`"+b.label+"`]"+m+"("+n.internalLabel+":`"+n.label+"`)");if(n!==c&&(e||n.immutable)){p=a.query.generateNodeValueConstraints(n);g=g.concat(p.whereElements);for(var t in p.parameters)p.parameters.hasOwnProperty(t)&&(k[t]=p.parameters[t])}});return{matchElements:f,whereElements:g,relationElements:h,returnElements:l,parameters:k}};a.query.generateNodeValueConstraints=function(b){var c={},d=[];if(void 0!==b.value&&
0<b.value.length){var e=a.provider.node.getConstraintAttribute(b.label),f=b.internalLabel+"_"+e;if(1<b.value.length)if(void 0!==b.isNegative&&b.isNegative){var g=0;b.value.forEach(function(b){b=e===a.query.NEO4J_INTERNAL_ID?b.internalID:b.attributes[e];0===g?(c[f]=b,g++):c[f+g++]=b})}else c[f]=[],b.value.forEach(function(b){c[f].push(e===a.query.NEO4J_INTERNAL_ID?b.internalID:b.attributes[e])}),e===a.query.NEO4J_INTERNAL_ID?d.push("ID("+b.internalLabel+") IN {`"+f+"`}"):d.push(b.internalLabel+"."+
e+" IN {`"+f+"`}");else c[f]=e===a.query.NEO4J_INTERNAL_ID?b.value[0].internalID:b.value[0].attributes[e],void 0!==b.isNegative&&b.isNegative||(e===a.query.NEO4J_INTERNAL_ID?d.push("ID("+b.internalLabel+") = {`"+f+"`}"):d.push(b.internalLabel+"."+e+" = {`"+f+"`}"))}return{parameters:c,whereElements:d}};a.query.getRelevantLinks=function(a,c,d){var b=d.slice(),f=[],g=[];b.forEach(function(a){(void 0!==a.target.value&&0<a.target.value.length||a.target===c||a.target.isNegative)&&f.push(a)});f.forEach(function(a){b.splice(b.indexOf(a),
1)});f.forEach(function(c){var d=c.source;for(c=!0;c;){var e=null;b.forEach(function(a){a.target===d&&(e=a)});null===e?c=!1:e.source===a?(g.push(e),b.splice(b.indexOf(e),1),c=!1):(g.push(e),b.splice(b.indexOf(e),1),d=e.source)}});return f.concat(g)};a.query.getLinksToRoot=function(b,c){for(var d=[],e=b;e!==a.graph.getRootNode();){for(var f,g=0;g<c.length;g++){var h=c[g];if(h.target===e){f=h;break}}f&&(d.push(f),e=f.source)}return d};a.query.generateResultQuery=function(b){var c=a.graph.getRootNode(),
d=a.query.generateQueryElements(c,c,a.query.getRelevantLinks(c,c,a.graph.links),!0),e=d.matchElements,f=d.whereElements,g=d.relationElements,h=[],l=[],d=d.parameters,k=a.provider.node.getResultOrderByAttribute(c.label);if(k){var m=a.provider.node.isResultOrderAscending(c.label)?"ASC":"DESC";l.push("ORDER BY "+k+" "+m)}l.push("LIMIT "+a.query.MAX_RESULTS_COUNT);k=a.provider.node.getReturnAttributes(c.label);if(b)h.push(c.internalLabel),g.forEach(function(a){h.push(a)});else for(b=0;b<k.length;b++)g=
k[b],g===a.query.NEO4J_INTERNAL_ID?h.push("ID("+c.internalLabel+") AS "+a.query.NEO4J_INTERNAL_ID.queryInternalName):h.push(c.internalLabel+"."+g+" AS "+g);b="MATCH "+e.join(", ")+(0<f.length?" WHERE "+f.join(" AND "):"")+" RETURN DISTINCT "+h.join(", ")+" "+l.join(" ");c=a.provider.node.filterResultQuery(c.label,{statement:b,matchElements:e,whereElements:f,withElements:[],returnElements:h,endElements:l,parameters:d});c.statement=a.query.prefilter+c.statement;return c};a.query.generateNodeCountQuery=
function(b){var c=a.query.generateQueryElements(a.graph.getRootNode(),b,a.query.getRelevantLinks(a.graph.getRootNode(),b,a.graph.links),!0),d=c.matchElements,e=c.whereElements,f=[],c=c.parameters,g=a.provider.node.getConstraintAttribute(b.label);g===a.query.NEO4J_INTERNAL_ID?f.push("count(DISTINCT ID("+b.internalLabel+")) as count"):f.push("count(DISTINCT "+b.internalLabel+"."+g+") as count");g="MATCH "+d.join(", ")+(0<e.length?" WHERE "+e.join(" AND "):"")+" RETURN "+f.join(", ");b=a.provider.node.filterNodeCountQuery(b,
{statement:g,matchElements:d,whereElements:e,returnElements:f,endElements:[],parameters:c});return{statement:a.query.prefilter+b.statement,parameters:b.parameters}};a.query.generateNodeValueQuery=function(b){var c=a.graph.getRootNode(),d=a.query.generateQueryElements(c,b,a.query.getRelevantLinks(c,b,a.graph.links),!0),e=d.matchElements,f=d.whereElements,g=[],h=[],l=d.parameters,k=a.provider.node.getValueOrderByAttribute(b.label);if(k){var m=a.provider.node.isValueOrderAscending(b.label)?"ASC":"DESC";
h.push("ORDER BY "+k+" "+m)}h.push("LIMIT "+a.query.VALUE_QUERY_LIMIT);k=a.provider.node.getReturnAttributes(b.label);a.provider.node.getConstraintAttribute(b.label);for(m=0;m<k.length;m++)k[m]===a.query.NEO4J_INTERNAL_ID?g.push("ID("+b.internalLabel+") AS "+a.query.NEO4J_INTERNAL_ID.queryInternalName):g.push(b.internalLabel+"."+k[m]+" AS "+k[m]);k=a.provider.node.getConstraintAttribute(c.label);k===a.query.NEO4J_INTERNAL_ID?g.push("count(DISTINCT ID("+c.internalLabel+")) AS count"):g.push("count(DISTINCT "+
c.internalLabel+"."+k+") AS count");a.query.COLLECT_RELATIONS_WITH_VALUES&&d.returnElements.forEach(function(a){g.push(a)});c="MATCH "+e.join(", ")+(0<f.length?" WHERE "+f.join(" AND "):"")+" RETURN "+g.join(", ")+" "+h.join(" ");b=a.provider.node.filterNodeValueQuery(b,{statement:c,matchElements:e,whereElements:f,returnElements:g,endElements:h,parameters:l});return{statement:a.query.prefilter+b.statement,parameters:b.parameters}};a.query.generateNodeRelationQuery=function(b){var c=a.query.getLinksToRoot(b,
a.graph.links),d=a.query.generateQueryElements(a.graph.getRootNode(),b,c,!1),c=d.matchElements,e=d.whereElements,f=[],g=[],d=d.parameters;c.push("("+b.internalLabel+":`"+b.label+"`)-[r]"+(a.query.USE_RELATION_DIRECTION?"->":"-")+"(x)");f.push("type(r) AS label");a.query.USE_PARENT_RELATION?f.push("head(labels(x)) AS target"):f.push("last(labels(x)) AS target");f.push("count(r) AS count");g.push("ORDER BY count(r) DESC");var h="MATCH "+c.join(", ")+(0<e.length?" WHERE "+e.join(" AND "):"")+" RETURN "+
f.join(", ")+" "+g.join(" ");b=a.provider.node.filterNodeRelationQuery(b,{statement:h,matchElements:c,whereElements:e,returnElements:f,endElements:g,parameters:d});return{statement:a.query.prefilter+b.statement,parameters:b.parameters}};a.result={};a.result.containerId="popoto-results";a.result.hasChanged=!0;a.result.resultCountListeners=[];a.result.resultListeners=[];a.result.graphResultListeners=[];a.result.RESULTS_PAGE_SIZE=10;a.result.onTotalResultCount=function(b){a.result.resultCountListeners.push(b)};
a.result.onResultReceived=function(b){a.result.resultListeners.push(b)};a.result.onGraphResultReceived=function(b){a.result.graphResultListeners.push(b)};a.result.parseGraphResultData=function(a){var b={},d={};a.results[1].data.forEach(function(a){a.graph.nodes.forEach(function(a){b.hasOwnProperty(a.id)||(b[a.id]=a)});a.graph.relationships.forEach(function(a){d.hasOwnProperty(a.id)||(d[a.id]=a)})});a=[];var e=[],f;for(f in b)b.hasOwnProperty(f)&&a.push(b[f]);for(var g in d)d.hasOwnProperty(g)&&e.push(d[g]);
return{nodes:a,edges:e}};a.result.updateResults=function(){if(a.result.hasChanged){void 0!==a.result.resultsXhr&&a.result.resultsXhr.abort();var b=a.query.generateResultQuery();a.result.lastGeneratedQuery=b;b={statements:[{statement:b.statement,parameters:b.parameters,resultDataContents:["row"]}]};if(0<a.result.graphResultListeners.length){var c=a.query.generateResultQuery(!0);a.result.lastGeneratedQuery=c;b.statements.push({statement:c.statement,parameters:c.parameters,resultDataContents:["graph"]})}a.logger.info("Results ==>");
a.result.resultsXhr=a.rest.post(b).done(function(b){a.logger.info("<== Results");var c=a.rest.response.parse(b)[0].map(function(b,c){return{resultIndex:c,label:a.graph.getRootNode().label,attributes:b}});a.result.lastResults=c;a.result.resultListeners.forEach(function(a){a(c)});if(0<a.result.graphResultListeners.length){var d=a.result.parseGraphResultData(b);a.result.graphResultListeners.forEach(function(a){a(d)})}a.result.isActive&&(b=d3.select("#"+a.result.containerId).selectAll(".ppt-result").data([]),
b.exit().remove(),b=d3.select("#"+a.result.containerId).selectAll(".ppt-result").data(c.slice(0,a.result.RESULTS_PAGE_SIZE),function(a){return a.resultIndex}),b.enter().append("div").attr("class","ppt-result").attr("id",function(a){return"popoto-result-"+a.resultIndex}).each(function(b){a.provider.node.getDisplayResults(b.label)(d3.select(this))}));a.result.hasChanged=!1}).fail(function(b,c,f){"abort"!==c?(a.logger.error(c+': error while accessing Neo4j server on URL:"'+a.rest.CYPHER_URL+'" defined in "popoto.rest.CYPHER_URL" property: '+
f),a.result.resultListeners.forEach(function(a){a([])})):a.logger.info("<=X= Results - Aborted!")})}};a.result.updateResultsCount=function(){0<a.result.resultCountListeners.length&&a.result.resultCountListeners.forEach(function(b){b(a.graph.getRootNode().count)})};a.result.generatePreQuery=function(){var b={ids:[]};a.result.lastResults.forEach(function(a){b.ids.push(a.attributes.id)});return{query:"MATCH (d) WHERE d.id IN $ids WITH d",param:b}};a.graph.voronoi=d3.voronoi().x(function(a){return a.x}).y(function(a){return a.y});
a.graph.recenterVoronoi=function(b){var c=[];a.graph.voronoi.polygons(b.map(function(a){a.x=a.x||0;a.y=a.y||0;return a})).forEach(function(a){if(a.length){var b=[];a.forEach(function(c){b.push([c[0]-a.data.x,c[1]-a.data.y])});b.point=a.data;c.push(b)}});return c};a.provider={};a.provider.colorScale=d3.scaleOrdinal(d3.schemeCategory10);a.provider.link={};a.provider.link.Provider={};a.provider.taxonomy={};a.provider.taxonomy.Provider={};a.provider.node={};a.provider.node.Provider={};a.provider.link.getTextValue=
function(b){if(a.provider.link.Provider.hasOwnProperty("getTextValue"))return a.provider.link.Provider.getTextValue(b);if(a.provider.link.DEFAULT_PROVIDER.hasOwnProperty("getTextValue"))return a.provider.link.DEFAULT_PROVIDER.getTextValue(b);a.logger.error("No provider defined for link getTextValue")};a.provider.link.getColor=function(b,c,d){if(a.provider.link.Provider.hasOwnProperty("getColor"))return a.provider.link.Provider.getColor(b,c,d);if(a.provider.link.DEFAULT_PROVIDER.hasOwnProperty("getColor"))return a.provider.link.DEFAULT_PROVIDER.getColor(b,
c,d);a.logger.error("No provider defined for getColor")};a.provider.link.getCSSClass=function(b,c){if(a.provider.link.Provider.hasOwnProperty("getCSSClass"))return a.provider.link.Provider.getCSSClass(b,c);if(a.provider.link.DEFAULT_PROVIDER.hasOwnProperty("getCSSClass"))return a.provider.link.DEFAULT_PROVIDER.getCSSClass(b,c);a.logger.error("No provider defined for getCSSClass")};a.provider.link.getDistance=function(b){if(a.provider.link.Provider.hasOwnProperty("getDistance"))return a.provider.link.Provider.getDistance(b);
if(a.provider.link.DEFAULT_PROVIDER.hasOwnProperty("getDistance"))return a.provider.link.DEFAULT_PROVIDER.getDistance(b);a.logger.error("No provider defined for getDistance")};a.provider.link.getSemanticValue=function(b){if(a.provider.link.Provider.hasOwnProperty("getSemanticValue"))return a.provider.link.Provider.getSemanticValue(b);if(a.provider.link.DEFAULT_PROVIDER.hasOwnProperty("getSemanticValue"))return a.provider.link.DEFAULT_PROVIDER.getSemanticValue(b);a.logger.error("No provider defined for getSemanticValue")};
a.provider.colorLuminance=function(a,c){a=String(a).replace(/[^0-9a-f]/gi,"");6>a.length&&(a=a[0]+a[0]+a[1]+a[1]+a[2]+a[2]);c=c||0;var b="#",e,f;for(f=0;3>f;f++)e=parseInt(a.substr(2*f,2),16),e=Math.round(Math.min(Math.max(0,e+e*c),255)).toString(16),b+=("00"+e).substr(e.length);return b};a.provider.link.DEFAULT_PROVIDER={getTextValue:function(b){if(b.type===a.graph.link.LinkTypes.VALUE)return a.provider.node.isTextDisplayed(b.target)?"":a.provider.node.getTextValue(b.target);var c="";b.type===a.graph.link.LinkTypes.SEGMENT&&
(c=" "+a.provider.node.getTextValue(b.target));return b.label+c},getDistance:function(b){return b.type===a.graph.link.LinkTypes.VALUE?1.625*(a.provider.node.getSize(b.source)+a.provider.node.getSize(b.target)):2.5*(a.provider.node.getSize(b.source)+a.provider.node.getSize(b.target))},getColor:function(b,c,d){if(b.type===a.graph.link.LinkTypes.VALUE)return"#525863";b=a.provider.colorScale(b.source.label+b.label+b.target.label);return"stroke"===d?a.provider.colorLuminance(b,-.2):b},getCSSClass:function(b,
c){var d="ppt-link__"+c;if(b.type===a.graph.link.LinkTypes.VALUE)d+="--value";else{var e="ppt-"+b.label.replace(/[^0-9a-z\-_]/gi,"");b.type===a.graph.link.LinkTypes.RELATION&&(d+="--relation",0===b.target.count&&(d+="--disabled"),d=d+" "+e)}return d},getSemanticValue:function(b){return a.provider.link.getTextValue(b)}};a.provider.link.Provider=a.provider.link.DEFAULT_PROVIDER;a.provider.taxonomy.getTextValue=function(b){if(a.provider.taxonomy.Provider.hasOwnProperty("getTextValue"))return a.provider.taxonomy.Provider.getTextValue(b);
if(a.provider.taxonomy.DEFAULT_PROVIDER.hasOwnProperty("getTextValue"))return a.provider.taxonomy.DEFAULT_PROVIDER.getTextValue(b);a.logger.error("No provider defined for taxonomy getTextValue")};a.provider.taxonomy.getCSSClass=function(b,c){if(a.provider.taxonomy.Provider.hasOwnProperty("getCSSClass"))return a.provider.taxonomy.Provider.getCSSClass(b,c);if(a.provider.taxonomy.DEFAULT_PROVIDER.hasOwnProperty("getCSSClass"))return a.provider.taxonomy.DEFAULT_PROVIDER.getCSSClass(b,c);a.logger.error("No provider defined for taxonomy getCSSClass")};
a.provider.taxonomy.DEFAULT_PROVIDER={getTextValue:function(a){return a},getCSSClass:function(a,c){var b=a.replace(/[^0-9a-z\-_]/gi,"");return"ppt-taxo__"+c+" "+b}};a.provider.taxonomy.Provider=a.provider.taxonomy.DEFAULT_PROVIDER;a.provider.node.DisplayTypes=Object.freeze({TEXT:0,IMAGE:1,SVG:2,SYMBOL:3});a.provider.node.getProvider=function(b){if(void 0===b)a.logger.error("Node label is undefined, no label provider can be found.");else{if(!a.provider.node.Provider.hasOwnProperty(b)){a.logger.debug("No direct provider found for label "+
b);for(var c in a.provider.node.Provider)if(a.provider.node.Provider.hasOwnProperty(c)){var d=a.provider.node.Provider[c];if(d.hasOwnProperty("children")&&-1<d.children.indexOf(b)){a.logger.debug("No provider is defined for label ("+b+"), parent ("+c+") will be used");c={parent:c};for(var e in d)d.hasOwnProperty(e)&&"children"!==e&&"parent"!==e&&(c[e]=d[e]);a.provider.node.Provider[b]=c;return a.provider.node.Provider[b]}}a.logger.debug("No label provider defined for label ("+b+") default one will be created from popoto.provider.node.DEFAULT_PROVIDER");
a.provider.node.Provider[b]={};for(var f in a.provider.node.DEFAULT_PROVIDER)a.provider.node.DEFAULT_PROVIDER.hasOwnProperty(f)&&(a.provider.node.Provider[b][f]=a.provider.node.DEFAULT_PROVIDER[f])}return a.provider.node.Provider[b]}};a.provider.node.getProperty=function(b,c){var d=a.provider.node.getProvider(b);if(!d.hasOwnProperty(c)){for(var e=d,f=!1;e.hasOwnProperty("parent")&&!f;)e=a.provider.node.getProvider(e.parent),e.hasOwnProperty(c)&&(d[c]=e[c],f=!0);f||(a.logger.debug('No "'+c+'" property found for node label provider ('+
b+"), default value will be used"),a.provider.node.DEFAULT_PROVIDER.hasOwnProperty(c)?d[c]=a.provider.node.DEFAULT_PROVIDER[c]:a.logger.debug('No default value for "'+c+'" property found for label provider ('+b+")"))}return d[c]};a.provider.node.getIsAutoLoadValue=function(b){return a.provider.node.getProperty(b,"isAutoLoadValue")};a.provider.node.getIsSearchable=function(b){return a.provider.node.getProperty(b,"isSearchable")};a.provider.node.getIsAutoExpandRelations=function(b){return a.provider.node.getProperty(b,
"autoExpandRelations")};a.provider.node.getSchema=function(b){return a.provider.node.getProperty(b,"schema")};a.provider.node.getReturnAttributes=function(b){var c=a.provider.node.getProvider(b),d={};if(c.hasOwnProperty("returnAttributes"))for(var e=0;e<c.returnAttributes.length;e++)c.returnAttributes[e]===a.query.NEO4J_INTERNAL_ID?d[a.query.NEO4J_INTERNAL_ID.queryInternalName]=!0:d[c.returnAttributes[e]]=!0;for(;c.hasOwnProperty("parent");)if(c=a.provider.node.getProvider(c.parent),c.hasOwnProperty("returnAttributes"))for(e=
0;e<c.returnAttributes.length;e++)c.returnAttributes[e]===a.query.NEO4J_INTERNAL_ID?d[a.query.NEO4J_INTERNAL_ID.queryInternalName]=!0:d[c.returnAttributes[e]]=!0;if(a.provider.node.DEFAULT_PROVIDER.hasOwnProperty("returnAttributes"))for(c=0;c<a.provider.node.DEFAULT_PROVIDER.returnAttributes.length;c++)a.provider.node.DEFAULT_PROVIDER.returnAttributes[c]!==a.query.NEO4J_INTERNAL_ID&&(d[a.provider.node.DEFAULT_PROVIDER.returnAttributes[c]]=!0);b=a.provider.node.getConstraintAttribute(b);b===a.query.NEO4J_INTERNAL_ID?
d[a.query.NEO4J_INTERNAL_ID.queryInternalName]=!0:d[b]=!0;b=[];for(var f in d)d.hasOwnProperty(f)&&(f===a.query.NEO4J_INTERNAL_ID.queryInternalName?b.push(a.query.NEO4J_INTERNAL_ID):b.push(f));0>=b.length&&b.push(a.query.NEO4J_INTERNAL_ID);return b};a.provider.node.getConstraintAttribute=function(b){return a.provider.node.getProperty(b,"constraintAttribute")};a.provider.node.getDisplayAttribute=function(b){var c=a.provider.node.getProperty(b,"displayAttribute");void 0===c&&(c=a.provider.node.getReturnAttributes(b),
c=0<c.length?c[0]:a.provider.node.getConstraintAttribute(b));return c};a.provider.node.getPredefinedConstraints=function(b){return a.provider.node.getProperty(b,"getPredefinedConstraints")()};a.provider.node.filterResultQuery=function(b,c){return a.provider.node.getProperty(b,"filterResultQuery")(c)};a.provider.node.getValueOrderByAttribute=function(b){return a.provider.node.getProperty(b,"valueOrderByAttribute")};a.provider.node.isValueOrderAscending=function(b){return a.provider.node.getProperty(b,
"isValueOrderAscending")};a.provider.node.getResultOrderByAttribute=function(b){return a.provider.node.getProperty(b,"resultOrderByAttribute")};a.provider.node.isResultOrderAscending=function(b){return a.provider.node.getProperty(b,"isResultOrderAscending")};a.provider.node.getTextValue=function(b,c){return a.provider.node.getProperty(b.label,"getTextValue")(b,c)};a.provider.node.getSemanticValue=function(b){return a.provider.node.getProperty(b.label,"getSemanticValue")(b)};a.provider.node.getSVGPaths=
function(b){return a.provider.node.getProperty(b.label,"getSVGPaths")(b)};a.provider.node.isTextDisplayed=function(b){return a.provider.node.getProperty(b.label,"getIsTextDisplayed")(b)};a.provider.node.getSize=function(b){return a.provider.node.getProperty(b.label,"getSize")(b)};a.provider.node.getColor=function(b,c){return a.provider.node.getProperty(b.label,"getColor")(b,c)};a.provider.node.getCSSClass=function(b,c){return a.provider.node.getProperty(b.label,"getCSSClass")(b,c)};a.provider.node.getIsGroup=
function(b){return a.provider.node.getProperty(b.label,"getIsGroup")(b)};a.provider.node.getNodeDisplayType=function(b){return a.provider.node.getProperty(b.label,"getDisplayType")(b)};a.provider.node.getImagePath=function(b){return a.provider.node.getProperty(b.label,"getImagePath")(b)};a.provider.node.getImageWidth=function(b){return a.provider.node.getProperty(b.label,"getImageWidth")(b)};a.provider.node.getImageHeight=function(b){return a.provider.node.getProperty(b.label,"getImageHeight")(b)};
a.provider.node.filterNodeValueQuery=function(b,c){return a.provider.node.getProperty(b.label,"filterNodeValueQuery")(b,c)};a.provider.node.filterNodeCountQuery=function(b,c){return a.provider.node.getProperty(b.label,"filterNodeCountQuery")(b,c)};a.provider.node.filterNodeRelationQuery=function(b,c){return a.provider.node.getProperty(b.label,"filterNodeRelationQuery")(b,c)};a.provider.node.getDisplayResults=function(b){return a.provider.node.getProperty(b,"displayResults")};a.provider.node.DEFAULT_PROVIDER=
{isSearchable:!0,autoExpandRelations:!1,isAutoLoadValue:!1,returnAttributes:[a.query.NEO4J_INTERNAL_ID],valueOrderByAttribute:"count",isValueOrderAscending:!1,resultOrderByAttribute:null,isResultOrderAscending:!0,constraintAttribute:a.query.NEO4J_INTERNAL_ID,displayAttribute:void 0,getPredefinedConstraints:function(){return[]},filterResultQuery:function(a){return a},getDisplayType:function(b){return a.provider.node.DisplayTypes.TEXT},getSize:function(a){return 50},getColor:function(b){if(b.type===
a.graph.node.NodeTypes.VALUE)return a.provider.node.getColor(b.parent);var c="";b.hasOwnProperty("parent")&&(c=b.parent.label);return a.provider.colorScale(c+(b.parentRel||"")+b.label)},getCSSClass:function(b,c){var d=b.label.replace(/[^0-9a-z\-_]/gi,""),e="ppt-node__"+c;b.type===a.graph.node.NodeTypes.ROOT&&(e+="--root");b.type===a.graph.node.NodeTypes.CHOOSE&&(e+="--choose");b.type===a.graph.node.NodeTypes.GROUP&&(e+="--group");b.type===a.graph.node.NodeTypes.VALUE&&(e+="--value");void 0!==b.value&&
0<b.value.length&&(e+="--value-selected");0===b.count&&(e+="--disabled");return e+" "+d},getIsGroup:function(a){return!1},getIsTextDisplayed:function(a){return!0},getTextValue:function(b,c){var d="",e=a.provider.node.getDisplayAttribute(b.label);if(b.type===a.graph.node.NodeTypes.VALUE)d=e===a.query.NEO4J_INTERNAL_ID?""+b.internalID:""+b.attributes[e];else if(void 0!==b.value&&0<b.value.length)if(e===a.query.NEO4J_INTERNAL_ID){var f="";b.value.forEach(function(a){d+=f+a.internalID;f=" or "})}else f=
"",b.value.forEach(function(a){d+=f+a.attributes[e];f=" or "});else d=b.label;return d},getSemanticValue:function(b){var c="",d=a.provider.node.getDisplayAttribute(b.label);if(b.type===a.graph.node.NodeTypes.VALUE)c=d===a.query.NEO4J_INTERNAL_ID?""+b.internalID:""+b.attributes[d];else if(void 0!==b.value&&0<b.value.length)if(d===a.query.NEO4J_INTERNAL_ID){var e="";b.value.forEach(function(a){c+=e+a.internalID;e=" or "})}else e="",b.value.forEach(function(a){c+=e+a.attributes[d];e=" or "});else c=
b.label;return c},getImagePath:function(a){return"image/node/"+a.label.toLowerCase()+"/"+a.label.toLowerCase()+".svg"},getSVGPaths:function(b){var c=a.provider.node.getSize(b);return[{d:"M 0, 0 m -"+c+", 0 a "+c+","+c+" 0 1,0 "+2*c+",0 a "+c+","+c+" 0 1,0 -"+2*c+",0",fill:"transparent",stroke:a.provider.node.getColor(b),"stroke-width":"2px"}]},getImageWidth:function(b){return 2*a.provider.node.getSize(b)},getImageHeight:function(b){return 2*a.provider.node.getSize(b)},filterNodeValueQuery:function(a,
c){return c},filterNodeCountQuery:function(a,c){return c},filterNodeRelationQuery:function(a,c){return c},displayResults:function(b){var c=b.data()[0],d=a.provider.node.getReturnAttributes(c.label),e=b.append("table").attr("class","ppt-result-table");d.forEach(function(b){var d=b;a.query.NEO4J_INTERNAL_ID===b&&(d=a.query.NEO4J_INTERNAL_ID.queryInternalName);var f=e.append("tr");f.append("th").text(function(){return b===a.query.NEO4J_INTERNAL_ID?"internal ID:":b+":"});void 0!==c.attributes[d]&&f.append("td").text(function(a){return a.attributes[d]})})}};
return a}();
